window.orig_data = [["07/2015", "07/2015", "rsyncrun", "ipsum", "Rsync your code to server and run.", "https://github.com/Luiti/rsyncrun"], ["05/2015", "06/2015", "lui", "ipsum", "A simple deployment setup tool, inspired by luigi and homebrew.", "https://github.com/Luiti/lui"], ["04/2015", "05/2015", "luigi", "ipsum", "Luigi is a Python module that helps you build complex pipelines of batch jobs. It handles dependency resolution, workflow management, visualization etc. It also comes with Hadoop support built in. ", "https://github.com/17zuoye/luigi"], ["04/2015", "04/2015", "oracle_interview_calculation", "ipsum", "简单来说，我想通过这个作品来向社区呼吁，雇主应该少让弱势应聘者浪费时间去做这些无聊的面试题，因为每个人的时间都很宝贵。", "https://github.com/mvj3/oracle_interview_calculation"], ["04/2015", "05/2015", "validata", "ipsum", "Validata = Validate + Data.", "https://github.com/Luiti/validata"], ["01/2015", "07/2015", "luiti", "ipsum", "A time task management framework, support multiple projects, built on top of luigi.", "https://github.com/Luiti/luiti"], ["01/2015", "03/2015", "examples", "ipsum", "Some Human lang design examples.", "https://github.com/human-lang/examples"], ["12/2014", "08/2015", "pyirt", "ipsum", "A python library of IRT algorithm", "https://github.com/17zuoye/pyirt"], ["10/2014", "05/2015", "nested-keys", "ipsum", "CRUD nested keys on JavaScript object.", "https://github.com/17zuoye/nested-keys"], ["10/2014", "05/2015", "sample-diff", "ipsum", "Sample diff.", "https://github.com/17zuoye/sample-diff"], ["09/2014", "04/2015", "detdup", "ipsum", "Detect duplicated items。内容排重框架。", "https://github.com/mvj3/detdup"], ["09/2014", "05/2015", "textmulclassify", "ipsum", " 为给定的一段文本抽取一个或多个基于知识树的标签。", "https://github.com/17zuoye/textmulclassify"], ["07/2014", "05/2015", "tfidf", "ipsum", "Compute tf idf with idf and tfidf cache independently", "https://github.com/17zuoye/tfidf"], ["07/2014", "05/2015", "article_segment", "ipsum", "Article segment", "https://github.com/17zuoye/article_segment"], ["07/2014", "05/2015", "phrase_recognizer", "ipsum", "Phrase Recognizer。英文短语识别。", "https://github.com/17zuoye/phrase_recognizer"], ["07/2014", "05/2015", "fill_broken_words", "ipsum", "Fill broken words", "https://github.com/mvj3/fill_broken_words"], ["07/2014", "05/2015", "region_unit_recognizer", "ipsum", "Region Unit Recognizer", "https://github.com/17zuoye/region_unit_recognizer"], ["07/2014", "05/2015", "model_cache", "ipsum", "Cache data in { item_id => item_content } format, supported storage are memory, sqlite and redis.", "https://github.com/Luiti/model_cache"], ["06/2014", "05/2015", "compare_word", "ipsum", "Compare words in normalize format, includes cases, tenses, etc.", "https://github.com/17zuoye/compare_word"], ["06/2014", "05/2015", "split_block", "ipsum", "split sentences into different type of blocks.", "https://github.com/17zuoye/split_block"], ["06/2014", "07/2015", "etl_utils", "ipsum", "ETL Utils", "https://github.com/Luiti/etl_utils"], ["03/2014", "03/2014", "redmine.chosen.js", "ipsum", "Enable chosen.js on redmine's select boxes", "https://github.com/17zuoye/redmine.chosen.js"], ["03/2014", "05/2015", "normalize_nested_params", "ipsum", "Normalize nested params in JavaScript", "https://github.com/17zuoye/normalize_nested_params"], ["01/2014", "01/2014", "LetPaymentFly", "ipsum", "Let payment fly.", "https://github.com/mvj3/LetPaymentFly"], ["12/2013", "12/2013", "distribute_tree", "ipsum", "用于实现单个Cloud和多个Local服务器之间数据共享的 Rails Engine 。", "https://github.com/mvj3/distribute_tree"], ["12/2013", "12/2013", "mongoid_many_or_many_to_many_setter", "ipsum", "在Mongoid里，解决在_id主键存在情况下，通过另外一个uuid键来做多对多，一对多关系的兼容。", "https://github.com/mvj3/mongoid_many_or_many_to_many_setter"], ["12/2013", "12/2013", "mongoid_unpack_paperclip", "ipsum", "给含有paperclip的Mongoid 支持解压缩包和清理的封装。", "https://github.com/SunshineLibrary/mongoid_unpack_paperclip"], ["12/2013", "12/2013", "mongoid_sync_with_deserialization", "ipsum", "解决JSON同步数据时，不支持Time等类型序列化的问题。", "https://github.com/SunshineLibrary/mongoid_sync_with_deserialization"], ["12/2013", "05/2015", "active_model_as_json_filter", "ipsum", "直接通过配置属性来生成as_json。", "https://github.com/mvj3/active_model_as_json_filter"], ["12/2013", "12/2013", "mongoid_uuid_generator", "ipsum", "在Mongoid实例初始化后自动生成uuid字段。", "https://github.com/SunshineLibrary/mongoid_uuid_generator"], ["10/2013", "12/2013", "mongoid_touch_parents_recursively", "ipsum", "touch parents recursively in Mongoid", "https://github.com/SunshineLibrary/mongoid_touch_parents_recursively"], ["10/2013", "04/2015", "hangman", "ipsum", "Hangman is a word game played between two people. One person selects a secret word, and the other tries to determine the word by guessing it letter-by-letter.", "https://github.com/mvj3/hangman"], ["09/2013", "09/2013", "line-tree", "ipsum", "Line-tree parses indented lines of text and returns an array of the represented tree structure.", "https://github.com/SunshineLibrary/line-tree"], ["07/2013", "12/2013", "statlysis", "ipsum", "Statistical & Analysis in Ruby DSL", "https://github.com/mvj3/statlysis"], ["06/2013", "07/2013", "stepstepstep", "ipsum", "DSL for defining before_filters's dependencies like rake tasks.", "https://github.com/eoecn/stepstepstep"], ["06/2013", "07/2013", "qa-rails", "ipsum", "Rails 迷你问答论坛插件", "https://github.com/eoecn/qa-rails"], ["06/2013", "08/2013", "faye-online", "ipsum", "Faye Online user list and time count", "https://github.com/mvj3/faye-online"], ["06/2013", "04/2015", "cross_time_calculation", "ipsum", "If you want to compute the same user's online time from server log, who comes from multiple clients, so you needed to remove duplicate parts.", "https://github.com/mvj3/cross_time_calculation"], ["06/2013", "06/2013", "acts_as_time_racing", "ipsum", "Record one item's start and finish time", "https://github.com/mvj3/acts_as_time_racing"], ["05/2013", "07/2013", "rack_image_assets_cache_control", "ipsum", "Cache Control Images Assets in rails development", "https://github.com/eoecn/rack_image_assets_cache_control"], ["04/2013", "10/2013", "markdown-ruby-china", "ipsum", "", "https://github.com/mvj3/markdown-ruby-china"], ["04/2013", "04/2013", "ucenter_authcode", "ipsum", "在Ruby里实现UCenter的用户信息认证解密。", "https://github.com/eoecn/ucenter_authcode"], ["04/2013", "08/2013", "pygments.rb", "ipsum", "pygments wrapper for ruby", "https://github.com/eoecn/pygments.rb"], ["04/2013", "01/2013", "simple_bitbucket", "ipsum", "", "https://github.com/eoecn/simple_bitbucket"], ["04/2013", "05/2013", "rake_notifier", "ipsum", "Notify of Rake exceptions via email", "https://github.com/eoecn/rake_notifier"], ["04/2013", "03/2013", "videojs_rails", "ipsum", "Video JS for Rails 3.1 Asset Pipeline", "https://github.com/eoecn/videojs_rails"], ["04/2013", "03/2013", "only_one_rake", "ipsum", "Ensure only one rake is running at a time", "https://github.com/eoecn/only_one_rake"], ["04/2013", "07/2013", "rails3_acts_as_paranoid", "ipsum", "ActiveRecord (>=3.0) plugin which allows you to hide and restore records without actually deleting them.", "https://github.com/eoecn/rails3_acts_as_paranoid"], ["04/2013", "04/2013", "markdownizer", "ipsum", "Render any text as markdown, with code highlighting and all!", "https://github.com/mvj3/markdownizer"], ["01/2013", "06/2013", "activerecord_idnamecache", "ipsum", "Use Mysql AUTO_INCREMENT to support id name cache", "https://github.com/mvj3/activerecord_idnamecache"], ["01/2013", "01/2013", "mongoid-mapreduce", "ipsum", "Mongoid MapReduce provides simple aggregation functions to your models using MongoDB map/reduce", "https://github.com/mvj3/mongoid-mapreduce"], ["08/2011", "01/2014", "logpos", "ipsum", "Use binary search to seek a position in logs", "https://github.com/mvj3/logpos"], ["12/2009", "07/2015", "deviantart-douban", "ipsum", "Automatically exported from code.google.com/p/deviantart-douban", "https://github.com/mvj3/deviantart-douban"]];
window.repo_to_language_dict = {"activerecord_idnamecache":"Ruby","active_model_as_json_filter":"Ruby","acts_as_time_racing":"Ruby","cross_time_calculation":"Ruby","detdup":"Python","deviantart-douban":"CSS","distribute_tree":"Ruby","faye-online":"Ruby","fill_broken_words":"Python","hangman":"Ruby","LetPaymentFly":"Ruby","logpos":"Ruby","markdown-ruby-china":"Ruby","markdownizer":"Ruby","mongoid-mapreduce":"Ruby","mongoid_many_or_many_to_many_setter":"Ruby","etl_utils":"Python","lui":"Python","luiti":"Python","model_cache":"Python","rsyncrun":"Python","validata":"Python","examples":"CoffeeScript","article_segment":"Python","compare_word":"Python","luigi":"Python","nested-keys":"JavaScript","normalize_nested_params":"JavaScript","phrase_recognizer":"Python","pyirt":"Python","redmine.chosen.js":"JavaScript","region_unit_recognizer":"Python","sample-diff":"CoffeeScript","split_block":"Python","textmulclassify":"Python","tfidf":"Python","line-tree":"Ruby","mongoid_sync_with_deserialization":"Ruby","mongoid_touch_parents_recursively":"Ruby","mongoid_unpack_paperclip":"Ruby","mongoid_uuid_generator":"Ruby","statlysis":"Ruby","only_one_rake":"Ruby","pygments.rb":"C","qa-rails":"JavaScript","rack_image_assets_cache_control":"Ruby","rails3_acts_as_paranoid":"Ruby","rake_notifier":"Ruby","simple_bitbucket":"Ruby","stepstepstep":"Ruby","ucenter_authcode":"Ruby","videojs_rails":"Ruby","draft":"HTML"};
window.fork_repos = ["line-tree", "luigi", "markdownizer", "markdown-ruby-china", "mongoid-mapreduce", "pygments.rb", "pyirt", "rails3_acts_as_paranoid", "rake_notifier", "ucenter_authcode", "videojs_rails"];




window.repo_to_homepage = _.reduce(orig_data, function(dict, item) {
  dict[item[2]] = item[5];
  return dict;
}, {});

// Define project weight
orig_repo_weights = {
  "42": [
    "luiti",
  ],
  "30": [
    "detdup",
    "textmulclassify",
    "statlysis",
  ],
  "20": [
    "rsyncrun",
    "tfidf",
    "phrase_recognizer",
    "fill_broken_words",
    "region_unit_recognizer",
    "model_cache",
    "etl_utils",

    "sample-diff",

    "active_model_as_json_filter",
    "hangman",
    "qa-rails",
    "faye-online",
    "activerecord_idnamecache",
  ],
  "17": [
    "validata",

    "distribute_tree",
    "mongoid_touch_parents_recursively",
    "mongoid_unpack_paperclip",
    "mongoid_sync_with_deserialization",
    "mongoid_uuid_generator",
    "mongoid_touch_parents_recursively",
    "logpos",

    "deviantart-douban",
  ]
};
window.repo_weights = {};  // export API
_.each(_.keys(orig_repo_weights), function(font_size) {
  _.each(orig_repo_weights["" + font_size], function(repo_name) {
    repo_weights[repo_name] = "" + font_size + "px";
  });
});


window.repos = _.map(orig_data, function(array) { return array.slice(0, 4); });
window.repos = _.map(repos, function(array) {
  var date_begin = array[0];
  var date_end   = array[1];

  function fix_date_compare(date) {
    return new Date("01 " + date.replace("/", " "));
  }
  if (fix_date_compare(date_begin) >= fix_date_compare(date_end)) {
    array[0] = date_end;
    array[1] = date_begin;
  };

  if (date_begin == date_end) {
    return array.slice(1, array.length);
  };

  return array;
});


$(document).ready(function() {

  var title = $(".post").find(".post-header");  // .post-title
  var title_template = _.template("<div>"
    + "I'm David Chen, also known as <a href='https://github.com/mvj3' target='_blank'>@mvj3</a>, have created <b><%= open_source_by_self %> open source projects</b> and forked <b><%= open_source_by_fork %></b> projects in my daily jobs since 2009."
    + " I really enjoy it, after 2013, I used to write private business code and open source code <b>concurrently</b> and <b>modularly</b>."
    + "</br>"
    + "</br>"
    + "Mostly, I use Python to do <b>data processing</b>, and use Ruby and JavaScript to do <b>web development</b>."
    + "Take a look at the below <b>timesheet</b> of my open source projects development."
    + "</div>"
  );
  title.html(title_template({
    "open_source_by_self": repos.length - fork_repos.length,
    "open_source_by_fork": fork_repos.length,
  }));
  title.css("font-size", "18px");


  var repo_url = _.template("<a href='<%= repo_url %>' target='_blank' style='font-size:<%= font_size %>;'><%= repo_name %></a>");


  $.getJSON("/bower_components/github-language-colors/colors.json", function(color_json) {
    // 1. init Timesheet
    new Timesheet('timesheet', 2013, 2015, repos);

    // 2. modify programming language color
    var timesheet_dom = $("#timesheet");

    // modify timesheet CSS background
    // timesheet_dom.css("background-color", "white");
    // timesheet_dom.find("div.scale section").css("color", "black");
    // timesheet_dom.find("div.scale section").slice(-3).css("width", "200px");

    // 3. modify bubble
    _.each(timesheet_dom.find("li"), function(li) {
      var repo = $(li).find("span.label");
      var repo_name = repo.text();
      var color_render = $(li).find("span.bubble");

      // 3.1. by projects's programming language color
      var real_color = color_json[repo_to_language_dict[repo_name]];
      color_render.css("background-color", real_color);

      // 3.2. add url
      repo.html(repo_url({"repo_name": repo_name, "repo_url": repo_to_homepage[repo_name], "font_size": repo_weights[repo_name]}));
    });

    // 4. draw programming language trends
    function draw_language_color_picker(timesheet_dom, repo_to_language_dict) {
      var language_to_repos = _.groupBy(_.keys(repo_to_language_dict), function(repo) {
        return repo_to_language_dict[repo];
      });
      var languages_sorted = _.sortBy(_.keys(language_to_repos), function(language) {
        return 0 - (language_to_repos[language].length);
      });

      var label_template = _.template(""
        + "<li>"
        + "<span class='label' style='background-color:<%= color %>;'></span>"
        + "<span class='text'><%= language %>: <%= count %></span>"
        + "</li>");
      var labels = _.map(languages_sorted, function(language) {
        return label_template({
          "color": color_json[language],
          "language": language,
          "count": language_to_repos[language].length
        });
      });

      var labels_dom = $("<ul id='language_labels'>" + labels.join("") + "</ul>");
      /* put this labels div at the top left of this timesheet. */
      labels_dom.css({
        "z-index": "100",
        "position": "absolute",
        "margin-top": "30px",
        "margin-left": "30px",
        "list-style-type": "none",
      });
      labels_dom.find("li span.text").css({
        "color": "white",
        "font-size": "12px",
      });

      /* copy CSS attribute from timesheet .bubble */
      labels_dom.find("li span.label").css({
        "width": "42px",
        "height": "7px",
        "display": "block",
        "float": "left",
        "position": "relative",
        "top": "7px",
        "border-radius": "4px",
        "margin": "0 10px 0 0",
        "opacity": "0.7",
      });

      timesheet_dom.prepend(labels_dom);
    };
    draw_language_color_picker(timesheet_dom, repo_to_language_dict);


    // Setup `marked` function
    marked.setOptions({
      renderer: new marked.Renderer(),
      breaks: true,
    });

    // render project details that written in Markdown document format.
    var detail_dom = $("pre#project_groups");
    var detail_orig_text = detail_dom.text();
    var detail_markdown_rendered = marked(detail_orig_text);
    detail_dom.html(detail_markdown_rendered).show();  // fix markdown rending delayed.

    // let two divs are the same width.
    var timesheet_width = $("#timesheet").css("width");
    /*
    detail_dom.css({
      "width": timesheet_width,
      "margin-top": "20px",
      //"word-wrap": "break-word",
    });
    */

    // fix anchor dont appear before markdown rendered.
    if (window.location.hash) {  // fix dead loop.
      window.location = window.location.hash;
    }

  });

});
