<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[世界的审美！]]></title>
  <link href="http://mvj3.github.io/atom.xml" rel="self"/>
  <link href="http://mvj3.github.io/"/>
  <updated>2013-12-18T15:54:03+08:00</updated>
  <id>http://mvj3.github.io/</id>
  <author>
    <name><![CDATA[mvj3]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[人类思维和软件工程学]]></title>
    <link href="http://mvj3.github.io/2013/12/15/human-mind-and-software-engineering/"/>
    <updated>2013-12-15T16:19:00+08:00</updated>
    <id>http://mvj3.github.io/2013/12/15/human-mind-and-software-engineering</id>
    <content type="html"><![CDATA[<h2>引言</h2>

<p>本文试图从直观的角度阐述如何做好常规的软件工程，保持良好的开发进度和可维护性，同时让项目经验对技术社区具有启发意义。Github源代码托管和社交网站里的JavaScript和Ruby等开源代码繁多火爆的盛景无疑充分地说明了这一点。</p>

<h2>人类思维特点</h2>

<p>试着把十根左右的火柴散乱地倒在地上，你会发觉你无法一下子看清有多少根。请注意，这里是<strong>看清</strong>，接着你可以在几秒之内慢慢地<strong>数清</strong>有多少根火柴。</p>

<p>这就是一般人类思维的极限和特点，人无法同时在脑子直观地在同一个层面掌握六七个以上不同事物。</p>

<p>再换个例子就是手机号码比生日难记的多。手机号码首三位是给运营商用的， 后面的8位被用于地区和用户编码了，对于人脑记忆而言毫无规则。而生日首先已经被人类经验分成了年份和月日这样两层，年份除去世纪就是一个两位数了，而月日是由大小不超过12的两个简单数字组成的。</p>

<h2>混沌时代</h2>

<p>试想你现在要去写一个猜单词游戏客户端，目标是如何在有限步骤内猜中更多的单词。这个需求可不是你可以用一个MVC框架可以套用的，你得自己去组织代码。</p>

<p>一开始你大概设计了基本的算法框架，先在一个文件里写着，不断的抽取方法，刚开始看着还不错。</p>

<p>当代码越来越多失去控制的时候，你考虑是否可以把算法独立出去作为一个库存在了。这样你就有了主程序和算法库两个文件。</p>

<p>接着你发现对方的服务器有时发生超时或内部错误，网络访问速度对于一次要执行几百次的程序也太慢，因此需要搭建本地的Mock服务器，这样你又多了remote和local两套实现机制，加上公用部分就是三个文件了。</p>

<p>如果再算上README等文档, 单词数据源文件，测试代码，你就会发现现在这差不多是一个成规模的项目了，它有十来个按目录分组的文件。</p>

<p>以上的例子并非虚构，它实际来源于我参加Strikingly的限时两天远程面试编程项目 <a href="https://github.com/mvj3/hangman/commits/master">Hangman</a> ，以上代码迭代重构过程完全可以从commit信息里得知。</p>

<h2>框架之初</h2>

<p>经历过 #混沌时代# 的我们，要去写一个涉及到数据库操作，业务逻辑，页面渲染，缓存管理，等等的复杂应用，如果没有一个像Rails这样便捷的Web框架，而自己一个一个去实现，那是一件多大工作量的事情。</p>

<p>有了框架，一切都很美满，用Rails漂亮的DSL配置下代码就可以了。</p>

<p>我相信没有哪个Rails用户不会为RESTful架构简洁的风格所体现出来的哲学所折服，GET, POST, PUT, DELETE 四种HTTP动词，index, new, create, show, edit, update, destroy 七种Controller方法，基本解决了大部分需求。别人来二次维护项目时也能很快地上手。</p>

<h2>框架之中</h2>

<p>然而实际的世界远远没有这么简单，Rails框架并不能覆盖到你全部的业务。有些人可能看过一则传授怎样画马的短篇漫画，</p>

<p><img src="http://mvj3.github.io/images/how_to_draw_a_horse.jpg" alt="怎样画马" /></p>

<p>最后一步背后的工作恰恰是最关键的，和耗时最长的，也即是我们常说的 <a href="https://duckduckgo.com/?q=%E4%B8%80%E4%B8%87%E5%B0%8F%E6%97%B6%E5%AE%9A%E5%BE%8B">一万小时定律</a> ，充分地强调了对技艺的理解力，经验，思考，和风格等。</p>

<p>当然在开源如此繁华和被倡导的年代，你可以使用插件，比如 exception_notification 去管理你的程序异常。</p>

<p>再有更大型的，比如devise用户认证，kaminari分页，等等，它们在Rails的MVC三层都扎根了，甚至还包括了数据库和前端javascript。</p>

<h2>框架之后</h2>

<p>慢慢地，有Rails开发经验的人，慢慢会发现总有一些不太适合放在Rails MVC三层里面的公共代码，于是一般都会把它们放到config/initializers/或lib/目录下。</p>

<p>但是总有一些比较大的东西让你Hold不住，举个例子，一个Model的业务逻辑是从压缩包里导入多层次的内容，并且得处理格式不规范等各种异常，那样很快就让这个Model增加了两百多行，方法数量超过了二十个，即使放到单独的文件里也还嫌多。描述过程的方法和公用的方法混合在一起相互引用，变量共享，中间结果缓存，很快就变得难以维护和扩展。</p>

<p>其实这个过程和Ruby社区的HTTP中间件处理库Rack做的事情在形式上有点类似，该库把HTTP请求的Header和body封装成Rack对象，然后被一个一个封装成模块的业务需求顺序地处理掉，过程类似于剥洋葱，最后把结果返回给客户端。</p>

<p>所以我们可以把这塞在一个文件的方法重构为以下概念上独立的三个部分。</p>

<ol>
<li>把解压缩和清理临时文件封装成一个Model插件。</li>
<li>把多层次内容的处理过程放到一个类似 Rack 的类中多个实例中，任何异常由调用方捕获。</li>
<li>处理过程中，数据格式验证可以直接代理到 Model.new(data).validated? 去。</li>
</ol>


<p>这样就清晰多了，调试也很方便。另外你也可以把它独立出去作为一个模块去处理了，这样model就瘦了不少。</p>

<h2>框架之上，来一场范式转移</h2>

<p>让我们再引申一下，对比之前全都放在一个Model类里去操作的做法，新的其实是建立了自己的结构，也就是框架。</p>

<p>这里面最重要的一点就是，一旦你写的代码和Rails本身的MVC框架无关时，代码组织超出了一定规模，而且它没有对应的开源库可以帮助，那么是有必要去专门为这个问题构造一个模块，框架，或者DSL了。</p>

<p>著名科学哲学家 Thomas S. Kuhn 写过一本《科学革命的结构》，里面提出了&#8221;范式转移&#8221;这一概念。举个物理学的范式转移例子，关于物质运动的解释，已经历经了从亚里士多德时代的模糊度量，到牛顿定律的理想化计算，再到爱因斯坦相对论的更精细化表述，这样三种体系。精度的变化只是表象中的其中一个度量，最关键的是里面大部分概念已经发生了本质性的变化，或者说那些名字已经不是原来的所指。比如物体的质量在在牛顿力学里不可变的，而在爱因斯坦相对论里因为速度的改变，质量也会发生变化。</p>

<p>同样，对于构建复杂应用的软件工程师来说，我们所使用的程序语言和软件框架就某个已启动项目来说一般很少发生变化，因为它们通常是业界认可和采用的模式和工具。编程过程中发生的各种技术问题，包括命名不清晰不一致，重复造轮子，破坏单一职责原则，Copy-Paste Style，意大利面条式代码，没有恰当的注释文档，等等，这里不一一列举，它们已经在Martin Folwer的著作《重构》一书中被详细论述。</p>

<p>针对一般的网站开发，我以为MVC只相当于三段论这种原则性的方法论而已，而做好一个复杂系统的根本前提是在于你的计算机科学方面的系统知识，数年实际项目编程经验，以及风格化的思考（这通常就是一种品味）。当我们面对的项目越复杂时，不断精细化和抽象化的思考和重构应该贯穿在项目的各个生命周期。于是，Rails, Mongoid, Devise等从中而出。</p>

<h2>《黑客与画家》</h2>

<p>很多人都赞同编程是一种创造性活动，再甚之是一种艺术，大可以和绘画等艺术形式媲美。</p>

<p>我以为这是对的，很多人都认同旧项目一般都难以维护，特别是糟糕的代码。同样对于一幅画来说，如果乱糟糟一堆，色彩，元素关系，细节刻画都很差劲，稍微修修补补绝对没有画龙点睛的效果，这后来者真的还不如重画。写程序对比其他艺术形式的一个好处就是可以通过采用或抽取开源组件来获得更好的可维护性。</p>

<p>Paul Graham 在《黑客与画家》一书中写到，&#8221;黑客与画家都是在试图创作出优秀的作品。他们本质上都不是在做研究，虽然在创作过程中，他们可能会发现一些新技术。&#8221;</p>

<p>而实际上我以为就艺术这一层面上两者并没有多大关系，唯一的共同点就是都倾向于视觉审美。代码不能拿来听，也不能拿来思考（算法还可以稍微拿来思考一下，但其本质是数学），它只能被拿来看，拿来用计算机去运行，在各个模块或函数中之间调试（那算法来说，这里就包含了具体工程上的很多细节优化实现）。</p>

<p>这里我想举一个有趣的例子，人们一般提起黑客，就想到那些用Vim, Emacs等纯文本界面编辑器的生活在黑底绿字终端下的大牛，IDE太笨重，而且无助于他们对代码的编写，调试，和思考。我不想比较其中的优劣，或者谁更正统，我认为纯文本目录导航浏览更接近把代码在放在大脑里思考的视觉化模式。</p>

<p>大家看看Vim的操作指南，它的使用模式里居然区分了浏览和编辑等模式，这对用惯了其他电脑程序的人而言无异于初次见到数学的等于符号和编程里的等于符号不等价一样让人惊异。在Vim里，我们用的更多的是浏览模式，编辑模式只有输入纯内容而已；而在浏览模式，你可以让光标在字与词，段落之间快速移动，可以把上下行对换，可以批量对齐，甚至可以拷贝某个长方形区块的文本。在此我想说的是，黑客和画家一样，思考的是元素与元素的关系，局部和整体的关系，从远观的良好命名的代码目录结构里可以看出项目架构（这个一般被Rails这种框架负责了），也可以从细观的在单个文件的某个类或者函数中把握其局部的独立性（这个就是代码良好的耦合性和单一职责原则）。</p>

<p>而如果采用IDE编写，它会依据行业公认的软件工程经验去组织和自动化代码编写和管理，强壮的Java社区的整个工业体系无疑说明了这一点。但是它严重破坏了代码组织的直观，架构和编程完全可以分开，编程从业人员变成其中一颗螺丝钉，编程也失去了创造性的乐趣，导致很多人错误地变成了只会一种软件框架的和吃青春饭的&#8221;码农&#8221;，很多人觉得三十岁后必然得转向管理或业务。</p>

<p>同是视觉性的绘画创作（我先声明我不会画画，所以言论可能有失偏颇），它不像诗歌，小说，音乐一样是生活在时间里的艺术，它力求的是直观，从全局和细部都可以欣赏，现代绘画有些已经抛弃细部了，它的画只能在一定距离外才能被有度量尺度限制的人眼看懂和欣赏它的美，比如印象派画家 莫奈的 <img src="http://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Claude_Monet%2C_Impression%2C_soleil_levant%2C_1872.jpg/780px-Claude_Monet%2C_Impression%2C_soleil_levant%2C_1872.jpg" alt="《印象·日出》" /> 。</p>

<p>拿编程和绘画打个比方就是，好的应用程序应该以user story为基本单位去勾勒程序架构，像一幅大型古典油画一样每个细部都可以拿出来欣赏把玩，而不是被扁平地代入一个一个现成的充满棱角的技术框架。其中具体的算法只是采用的材质不同，采用的开源库可能只是某个人物的帽子或者职业特征，技术架构体现了构图。真正优美的软件工程，应该让作为故事的皮肤和血肉恰到好处地覆盖骨架，使人一眼就能明白那是一个美人，而不是畸形得像是失败实验品的科学怪物。</p>

<p>事实上任何高级的创作必然是纯手工的，或者手工在里面起了必不可少的作用，这个看看奢侈品或咨询行业就知道了。</p>

<h2>回归本质</h2>

<p>试想一下，规划或者维护项目的时候，一般相关负责人都会画出一个类似思维导图的项目架构图，这个被业界普遍认可和采用。但是有些没亲手架构并实现过大型复杂多系统的人很容易会拿业务架构去套技术架构，搞出一个又一个貌合神离的子系统，而实际做的时候，变成了一个个只能靠HTTP通讯的孤立系统，类似于日常见到靠OAuth相互认证的互不关联的多个互联网网站一样，当超出一个MVC框架可以hold住时，他们开始束手无策。</p>

<p>针对人类思维特点，类似于键盘人体工程学，我们在编写软件时应该注意代码在浏览上对于人类思维的直观，除了比较熟知的一个函数里不要写太多代码外，同样一个作为基本单元的功能也最好不要超出六七个相对不同的函数集。有些人可能不太明白，他们确确实实见到了很多包括有名的开源项目里都有单文件里几百行甚至几千行的代码，但是这些优秀的代码通常都是在一个层次里面把函数集合放在单独抽取的模块里。不要担心做不到这一点，用不同颜色去标记不同国家地区的地图都可以仅用 <a href="http://zh.wikipedia.org/wiki/%E5%9B%9B%E8%89%B2%E5%AE%9A%E7%90%86">四种颜色来染色</a> 。</p>

<p>机械的本质就是齿轮之间的咬合，而相互驱动的齿轮绝对不能像混乱的意大利面条一样到处都是死结。</p>

<h2>得墨忒耳定律</h2>

<p>前段时间同事和我分享了一篇 <a href="http://pragprog.com/articles/tell-dont-ask">Tell, Don&rsquo;t Ask</a> 的文章，讲述了模块调用之间松耦合的原则，所谓&#8221;不在其位，不谋其政&#8221;，此观点也可以被归纳为 <a href="http://zh.wikipedia.org/wiki/%E5%BE%97%E5%A2%A8%E5%BF%92%E8%80%B3%E5%AE%9A%E5%BE%8B">得墨忒耳定律</a> 。</p>

<p>得墨忒耳定律处理的是已经划分好模块后如何相互之间通讯和单一职责的事情，而人类同时只能处理有限数量的相似对象的原则指明了什么时候应该适当重构的这条界限。</p>

<h2>别人说的一些话</h2>

<ul>
<li><a href="http://www.wentrue.net/blog/?p=1324">http://www.wentrue.net/blog/?p=1324</a> 为什么用R写代码很爽，是因为它把枯燥的敲键盘的工作变成有趣的大脑思维的工作。马上就被勤奋的cleverpig同学逮住了。 这几天看《黑客与画家》，看到Paul Graham很有创意地把黑客和画家的工作关联起来——正是我要表达的意思！</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[一个人的"github"]]></title>
    <link href="http://mvj3.github.io/2013/08/04/a-man-github/"/>
    <updated>2013-08-04T09:20:00+08:00</updated>
    <id>http://mvj3.github.io/2013/08/04/a-man-github</id>
    <content type="html"><![CDATA[<p>Github不是一个人做的，三个核心创始人在创业时都是写代码的，其中两个人作为程序员也十分有名，是不少有名开源项目的作者。对比这个星球上其他伟大的IT公司，Github网站的代码是能开源就尽量开源的，包括操作Git的grit，用作消息队列的resque，等。Github自然不是我做的，但作为一个自诩有好品味的程序员，我在努力向Github学习和实践它的精神和有益的工作方式，我要构建一个自己的&#8221;github&#8221;，在此也感谢我所处的公司 eoe 能给我自己去选择技术架构和工作进度这样相对灵活的工作方式的机会。</p>

<h2>缘起</h2>

<p>今年上半年我的主要工作内容是负责一个专注在线学习编程的单页面应用网站的技术部分。从缘起来说，eoe本身主要是做以Android为主的移动开发者服务的，应用市场，移动应用SDK统计，开发者大会活动等都有涉猎，正式的尝试进入IT培训从去年2012年中就开始了（当然想法会更早些）。</p>

<p>当时CEO @靳岩 让我调研公司进入类似 codecademy.com 在线编程领域方案的可能性，这对于当时刚做完<a href="http://mvj3.github.io/2012/11/01/android_eoemarket_data_collect_and_analysis_system_summary">优亿市场应用海量下载统计分析</a> 的算法与数据挖掘工程师无疑是一个很刺激的技术点。codecademy, codeschool 等这些国外在线编程网站毫无意外的展示了他们的创新性，codecademy 既支持JavaScript, HTML, CSS这些浏览器本身就提供编程环境的技术，也提供相对初级的Ruby, Python等后端语言在浏览器的模拟实现，他们用的相关技术包括用LLVM把代码编译成JavaScript执行的编译器Emscripten。codeschool里有个 <a href="http://code.eoe.cn/67">很有意思的地方</a> 就是，它支持在浏览器里按照他们的规则去用Objective-C写iOS程序，编译是在服务器进行的，并通过base64编码不断传回截图，然后模拟成仿佛浏览器真的成了完美的IDE一样，包括编译信息和出错栈。 对于我们要实现在浏览器里用Java编写Android程序，一般方案是采用传送到服务器编译执行，但是这样涉及到复杂的沙盒模型，且对服务器端资源消耗过大。我知道有一家真的实现了，他们前端用的是flash技术，但是这个只能针对简单快速编译的项目，而且我觉得这个脱离了要教会对方学习的本质，因为以后的实际演练肯定是在Eclipse等IDE里进行的，而你的浏览器在现有技术情况下肯定无法全部模拟。后来我也想到了可以以IDE插件的形式解决把线下教学搬到线上的基本构思，技术难度降低一半，这是后话。在教学中三环节 <code>教问练</code> 中，真正把教和练做好的公司大概就这几家了，问的话去是程序员都上的stackoverflow等网站就好了。</p>

<p>去年下半年做了偏前端的 <a href="http://skill.eoe.cn">技能测评</a>，和偏后端的 <a href="http://code.eoe.cn">gist.github.com 克隆网站</a> 。前者算基本没用过，后者不温不火，这让我明白了一个道理，如果我仅仅沉迷于技术实现，自己却无法分身去从事数种自己不熟悉或不太愿意实际执行的工作，那么它的命运就完全取决于组织的决定，因为一个真实产品的成长它需要不同职责的人的参与。前段时间听 @teahour 的一期 <a href="http://teahour.fm/2013/07/15/lean-startup-with-knewone.html">和knewone的李路聊聊技术和精益创业</a> 也聊到类似的情况，很有共鸣。</p>

<p>而公司在这半年也陆续做了些小规模的Android培训。今年2013春节后，正式开启线上教育项目，产品设计由 @iceskysl 主导和驱动，我开始做聊天技术的预演，内容运营部门则调动内外部资源继续制作教程内容。</p>

<h2>研发</h2>

<p>单页面学习应用 learn.eoe.cn 和 报名支付宣传 xuexie.eoe.cn 及后台管理的整体开发上线共历时大概三四个月，我负责的是 learn.eoe.cn（一位前端同事负责写CSS），其他的都是php项目组负责实施。</p>

<p>当 @iceskysl 设计好产品基本原型后，确认学习过程中为单页面应用，因为里面的聊天，问答，考试等的一些操作应该是尽量避免重载页面的。我自告奋勇去设计了学习系统的数据库设计，基本思想上按模块做命名空间切分，课程大纲设计为一个课程包含多个课时，一个课时包含多个小节，小节可以为视频，资料，测评等多种类型，这是内容部分。对应的学生数据则是一个学习数据表绑定一个课程，并关联观看视频监控记录，考试记录，和计时等。这期间，项目组内关于数据结构，或者说课程具体的产品设计需求，经过多次讨论，终于达成思路上的一致。</p>

<p>以下是现在上线后测试服务器里学习页面的多个模块的截图。
<img src="http://mvj3.github.io/images/one-man-github/learn_video.png" alt="learn_video" />
<img src="http://mvj3.github.io/images/one-man-github/learn_qa.png" alt="learn_qa" />
<img src="http://mvj3.github.io/images/one-man-github/learn_exam.png" alt="learn_exam" /></p>

<p>我对架构设计的原则是技术模块化，业务流程化，两者互相解耦。</p>

<h3>业务流程化</h3>

<p>对于一个学生来说，TA面对的主体是课程和TA的学习数据，其他都是依附于其之上。</p>

<p>对于内容管理人员来说，课程是标准的层级关联，视频和其他也只是依附于其之上。</p>

<p>对于我作为学习页面的技术负责人来说，用户是否付款和加入某个班级只是一个是非状态。用户的学习状态依赖于业务需求，可能需要结合多个数据源做操作判断，比如是否可以测评要保证你起码观看过教学视频及教学资料，是否学习完成也依赖于你对该课程所有课时的学习状态。</p>

<h3>技术模块化</h3>

<p>想清楚好以上清晰的业务流程骨架后，我开始本人4年技术生涯里最彻底的模块拆解，并开源出十多个模块。</p>

<p><strong>跨子域名用户登陆</strong>，用的是PHP写的单点登陆解决方案UCenter，我整理了 @iceskysl 从PHP改写的Ruby代码，并<a href="https://github.com/eoecn/ucenter_authcode">开源</a>出来。在应用时，有次遇到误把对方一个每次都变的cookies作为这边的唯一身份认证，这个在单域名操作体现不出来，而访问多个子域名后这边session就失效了。</p>

<p><strong>视频播放</strong>用的 <a href="http://www.videojs.com">VIDEO.JS</a> 框架，不需要太多配置代码。另外我想了个开源的<a href="https://github.com/eoecn/videojs_user_track">视频监控的方案</a>，就是把用户对不同时间段的观看频次对应的以秒为单位的数组里，播放一次是1, 最大是9，以此观察视频具体效果，和单个学生的学习疑点。从最近遇到的一个BUG来看，浏览器缓存了视频，但是网络是随时可断的，导致某些网络不太稳定的用户的监控数据可能是部分缺失的。所以监控数据还是得与业务逻辑彻底分开的，前者只应该作为业务判断参考之一。（有人可能会提到放在cookie里，但是其最大长度是4K，那么一个小时的视频 <code>1*2*3600=7200</code> 就放不下了）。</p>

<p><strong>参考资料</strong>用的是markdown编辑和渲染，我抽取了ruby-china的markdown渲染代码，并 <a href="https://github.com/eoecn/markdown-ruby-china">自动识别程序语言，文件名，别名等多种格式</a>。</p>

<p><strong>问答讨论</strong>是个太标准的CRUD应用，一个论坛无非是主题和回复，里面显示的用户名和头像其实都是可以在前端用JavaScript去组装的， <a href="http://mvj3.github.io/2013/05/28/fix-backbones-view-duplicated-events-bind/">用Backbones这个Javascript MVC框架实现模版和事件绑定</a>  ，添加完数据表后，直接用一个Rails Helper配置下即可，我把它取名为 <a href="https://github.com/eoecn/qa-rails">qa-rails</a> 。</p>

<p><strong>测评</strong>是个相对独立的业务，鉴于去年做过差不多的，这次实现更加精炼了些，JavaScript 239行，HAML两个模版60行。这块限于业务特殊无法作到开源。</p>

<p><strong>班级讨论</strong>是基于 <a href="https://github.com/faye/faye">Faye消息订阅发布系统</a> 做的，并实现了 <a href="https://github.com/eoecn/faye-online">在线用户显示和计时</a>，原理是绑定了Faye提供用户登入和登出的事件接口。 这里要特别感谢我们的一个女产品(条理清晰的黑盒测试)，是她用心的测试出了有这个用户的电脑非正常关闭浏览器造成服务器端一直在计时的错误。Faye 检测用户退出有两种方法，一种是服务器端的EventMachine定期检测client是否失去连接；另一种是客户端在浏览器关闭前发送disconnect请求(对应的配置选项是autodisconnect)，如果正常关闭那是ok的，但是如果用户取消关闭，那么这个faye client就死掉了，也就无法聊天，更新在线用户和计时。然后我想到了一种方案是，就是关闭autodisconnect，把这个事件改为发送让服务器三秒后才去检测这个client是否继续存活的请求，这样无论浏览器是否关掉，服务器 都照样主动检测。聊天室的弊端在于它的特点是需要中央服务器，无法支持过大的聊天室，这里暗示的一个信息是系统架构是可以按聊天室拆分做负载均衡的。</p>

<p>上面说的大部分都是从前端角度分析的，现在来说说后端。</p>

<p>随着项目不断迭代，我发现几乎大部分操作都直接绑定到用户学习状态表 LearnIssue 了，关联的课时和学习状态，每门课时对应的视频观看数据和考试信息都是代理过去，这样逻辑相对还是很清晰的。</p>

<p>在写单页面应用时，虽然像问答和聊天都独立出去用JavaScript载入了，但是还是需要同时载入几十个变量。<a href="http://ruby-china.org/topics/12477">一般人都会反应为什么不整合到Model里去呢</a> ，原因是我还把十多个数据合法验证加入到Controller里去了，这里包括后台人员录入的数据不规范和用户访问权限等，出错方式是给出带参数说明的 <code>redirect_to</code> URL ，比如 <code>?reason=course_invalid</code> ，这样后台可以随时调整并在前端验证。在调整业务的时候，我经常要去调整变量位置，所以就写了类似rake步骤依赖的 <a href="http://github.com/eoecn/stepstepstep">stepstepstep.gem</a> 去生成自动排序执行的14个before_filters，里面涉及一个图论算法。</p>

<p>这个项目一个很大的特色之一是对JSON的运用，比如学习状态，课程信息等。大部分是直接用 <a href="https://github.com/bdurand/json_record/">json_record</a> 配置的，效果等同于MongoDB文档存储（当然副作用是不能直接用SQL做字段本身的操作了），但是运维只需面对MySQL即可。我把项目设计成基本都是单表操作，现在一个学习页面的载入包含着近50条SQL查询，而响应时间却都还在300ms左右。</p>

<p>最后为了给大家一个相对直观的项目复杂度的理解，我运行 <code>bundle exec rake stats</code> 对Ruby源码情况做了简单统计，并对比由牛人 @huacnlee 主导开发的 Ruby China专业社区论坛。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>learn.eoe.cn
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Name                 | Lines |   LOC | Classes | Methods | M/C | LOC/M |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Controllers          |   558 |   356 |       9 |      24 |   2 |    12 |
</span><span class='line'>| Helpers              |    26 |    19 |       0 |       4 |   0 |     2 |
</span><span class='line'>| Models               |   690 |   529 |      17 |      54 |   3 |     7 |
</span><span class='line'>| Libraries            |   114 |    86 |       1 |       2 |   2 |    41 |
</span><span class='line'>| Integration tests    |     0 |     0 |       0 |       0 |   0 |     0 |
</span><span class='line'>| Functional tests     |    11 |     6 |       2 |       0 |   0 |     0 |
</span><span class='line'>| Unit tests           |     8 |     6 |       2 |       0 |   0 |     0 |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Total                |  1407 |  1002 |      31 |      84 |   2 |     9 |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>  Code LOC: 990     Test LOC: 12     Code to Test Ratio: 1:0.0
</span><span class='line'>
</span><span class='line'>ruby-china
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Name                 | Lines |   LOC | Classes | Methods | M/C | LOC/M |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Controllers          |  1587 |  1251 |      32 |     182 |   5 |     4 |
</span><span class='line'>| Helpers              |   365 |   301 |       0 |      41 |   0 |     5 |
</span><span class='line'>| Models               |  1542 |  1166 |      24 |     106 |   4 |     9 |
</span><span class='line'>| Mailers              |    18 |    15 |       2 |       1 |   0 |    13 |
</span><span class='line'>| Javascripts          |  6908 |  5006 |       1 |     546 | 546 |     7 |
</span><span class='line'>| Libraries            |   552 |   411 |       6 |      41 |   6 |     8 |
</span><span class='line'>| Api specs            |   171 |   148 |       0 |       2 |   0 |    72 |
</span><span class='line'>| Cell specs           |   127 |   106 |       0 |       0 |   0 |     0 |
</span><span class='line'>| Controller specs     |   678 |   572 |       0 |       0 |   0 |     0 |
</span><span class='line'>| Helper specs         |   364 |   290 |       0 |       0 |   0 |     0 |
</span><span class='line'>| Lib specs            |   229 |   173 |       0 |       0 |   0 |     0 |
</span><span class='line'>| Model specs          |  1034 |   859 |       3 |       0 |   0 |     0 |
</span><span class='line'>| Request specs        |    40 |    33 |       0 |       0 |   0 |     0 |
</span><span class='line'>| Routing specs        |    58 |    43 |       0 |       0 |   0 |     0 |
</span><span class='line'>| View specs           |    34 |    26 |       0 |       0 |   0 |     0 |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Total                | 13707 | 10400 |      68 |     919 |  13 |     9 |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>  Code LOC: 8150     Test LOC: 2250     Code to Test Ratio: 1:0.3
</span></code></pre></td></tr></table></div></figure>


<p>假设代码质量和风格差不多的话，从代码量来说 learn.eoe.cn 主体Ruby部分的复杂度是 ruby-china.org 的三分之一 （从Models和Controllers占比来说也是差不多的），对于一个单页应用来说这差不多了。唯一的区别是learn.eoe.cn的控制器方法行数比ruby-china.org大三倍，这和业务逻辑更加复杂有关。（Ruby China得排除基本都是外部静态js的这6908行统计数据。）</p>

<p>另外上午我写了一段Ruby脚本来统计 <a href="https://gist.github.com/mvj3/6149713">learn.eoe.cn Rails项目及其开源项目源码行数</a> ，结果为：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>[rails_engine_eoe]  Ruby:884 | JavaScript:15 | HAML:0
</span><span class='line'>[ucenter_authcode]  Ruby:78 | JavaScript:0 | HAML:0
</span><span class='line'>[rack_image_assets_cache_control]  Ruby:28 | JavaScript:0 | HAML:0
</span><span class='line'>[faye-online]  Ruby:678 | JavaScript:52 | HAML:0
</span><span class='line'>[qa-rails]  Ruby:259 | JavaScript:280 | HAML:183
</span><span class='line'>[videojs_user_track]  Ruby:140 | JavaScript:84 | HAML:0
</span><span class='line'>[stepstepstep]  Ruby:271 | JavaScript:0 | HAML:0
</span><span class='line'>[cross_time_calculation]  Ruby:143 | JavaScript:0 | HAML:0
</span><span class='line'>[/Users/mvj3/eoemobile/code/learn]  Ruby:4113 | JavaScript:1108 | HAML:517
</span><span class='line'>
</span><span class='line'>[total] Ruby:6721 | JavaScript:1539 | HAML:700
</span></code></pre></td></tr></table></div></figure>


<p>可以看到Ruby和JavaScript有三分之一左右是开源的，Ruby更多些。另外一个数据是git提交日志,  <code>1,347 commits / 21,477 ++ / 12,354 --</code> 。</p>

<p>这项目最大的遗憾就是没有测试，和互联网创业产品风格及资源配备等都很有关系，不过抽取的外部库比较重要或重逻辑的地方都写了必要的测试了。</p>

<p>注明: 本文仅代表个人观点，与实际所涉公司无关。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How do i create stepstepstep gem]]></title>
    <link href="http://mvj3.github.io/2013/07/13/how-do-i-create-stepstepstep-gem/"/>
    <updated>2013-07-13T16:41:00+08:00</updated>
    <id>http://mvj3.github.io/2013/07/13/how-do-i-create-stepstepstep-gem</id>
    <content type="html"><![CDATA[<p>A few months ago, I was writing a single page application about learning mobile development technology at <a href="http://learn.eoe.cn.">http://learn.eoe.cn.</a> This page contains lessons, a video, classes, teachers, students, reference material, question-to-answers, exams, chat messages, and their current all learning statuses and dependencies. In brief, there are fifteen steps to load this page, including privileges to judge, fourteen illegal <code>redirect_to</code> , etc. So I need to write a step dependencies management tool, like rake tasks.</p>

<p>At first, I thought maybe I could define several <code>proc</code>s in a single before_filter, but the execution context is really complicated. Then one day, I found action_jackson.gem, which was written by <a href="https://github.com/blakefrost/action_jackson">Blake Taylor</a> two years ago. The core implementation of this gem is to define each action as a method, and at last call a class method <code>register_filters</code> to register all these methods as <code>before_filter</code> independently. Of course, they&rsquo;re ordered by the earlier declarations. This implementation is not elegant, but the idea is really awesome, it doesn&rsquo;t break Rails&rsquo;s rules.</p>

<p>Then I got a deep understanding of the Rails controllers filters&rsquo;s implementation mechanism. Maybe <code>skip_before_filter</code> helped. In each <code>step</code>, I insert it first, extract all the inserted steps by <code>skip_before_filter</code>, then sort them by TSort(a topological sorting algorithm provided by Ruby standard library), and at last append them again to before_filters. It works, and all rspecs are passed.</p>

<p>I renamed it from action_jackson to stepstepstep, because the DSL is only a <code>step</code> class method, which handles all the details. Most of the implementations were rewritten, and I added rspecs . Thanks Blake Taylor :)</p>

<p>The project homepage is <a href="http://github.com/eoecn/stepstepstep">http://github.com/eoecn/stepstepstep</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[解决 Memcached::ServerError: object too large for cache 错误]]></title>
    <link href="http://mvj3.github.io/2013/05/28/solve-Memcached-ServerError-object-too-large-for-cache/"/>
    <updated>2013-05-28T15:28:32+08:00</updated>
    <id>http://mvj3.github.io/2013/05/28/solve-Memcached-ServerError-object-too-large-for-cache</id>
    <content type="html"><![CDATA[<h2>问题</h2>

<p>在添加 <a href="http://code.eoe.cn/1620">用jsbeautifier.org解压缩jing.fm的Web版的js代码
</a> 的长达7029行js代码后，后台服务器马上报500错误，对应错误信息是 <code>Memcached::ServerError: "object too large for cache". Key {"git_file_html_8741fc1d7923a820e7de64d996125a527792cc89"=&gt;"localhost:11211:8"}</code></p>

<h2>解决方案</h2>

<p>在添加 [用jsbeautifier.org解压缩jing.fm的Web版的js代码
配置memcached的-I选项以调整每个cache item的最大值。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>memcached -I 3m -p 11211 -v -m 512 -d
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[从Git的Log里列出今天提交的代码记录信息]]></title>
    <link href="http://mvj3.github.io/2013/05/28/list-ones-git-commit-messages-in-today-from-the-git-logs/"/>
    <updated>2013-05-28T15:28:32+08:00</updated>
    <id>http://mvj3.github.io/2013/05/28/list-ones-git-commit-messages-in-today-from-the-git-logs</id>
    <content type="html"><![CDATA[<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">GIT_USERNAME</span><span class="o">=</span><span class="k">$(</span>git config --global --get user.name<span class="k">)</span>;
</span><span class='line'>git log --author <span class="nv">$GIT_USERNAME</span> --no-merges --after<span class="o">={</span>1.day.ago<span class="o">}</span> |<span class="se">\</span>
</span><span class='line'>       cat |<span class="se">\</span>
</span><span class='line'>       grep -v <span class="s1">&#39;^commit &#39;</span> |<span class="se">\</span>
</span><span class='line'>       grep -v <span class="s1">&#39;^Author: &#39;</span> |<span class="se">\</span>
</span><span class='line'>       grep -v <span class="s1">&#39;^Date: &#39;</span> |<span class="se">\</span>
</span><span class='line'>       grep -v <span class="s2">&quot;^$&quot;</span> |<span class="se">\</span>
</span><span class='line'>       tail -r
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[解决Backbone视图的事件重复绑定]]></title>
    <link href="http://mvj3.github.io/2013/05/28/fix-backbone-view-duplicated-events-bind/"/>
    <updated>2013-05-28T15:28:32+08:00</updated>
    <id>http://mvj3.github.io/2013/05/28/fix-backbone-view-duplicated-events-bind</id>
    <content type="html"><![CDATA[<h2>原理</h2>

<p>Backbone的模版和事件绑定原理是输出HTML，供dom操作。然后利用Javascript代理机制进行对应的事件绑定。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">QAListTopicView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;click li&quot;</span><span class="o">:</span> <span class="s1">&#39;topic_show&#39;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">topic_show</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#qa_list_topic_template&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">()),</span>
</span><span class='line'>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">topics</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">topics</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">());</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">list_topic_view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QAListTopicView</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#qa ul&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">list_topic_view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果在View.render方法里进行事件绑定，那么就会对多重Backbone.View的多重实例进行重复绑定。</p>

<h2>例子</h2>

<p>详细的一个使用Backbone里的View和Event的例子见: <a href="https://github.com/eoecn/qa-rails/blob/master/app/assets/javascripts/qa-rails.js">https://github.com/eoecn/qa-rails/blob/master/app/assets/javascripts/qa-rails.js</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[统计分析DSL设计，解决惰性加载 和 作用域 两个问题]]></title>
    <link href="http://mvj3.github.io/2013/04/17/statlysis-analysis-design-solve-two-problems-lazy-loading-and-scope/"/>
    <updated>2013-04-17T21:42:44+08:00</updated>
    <id>http://mvj3.github.io/2013/04/17/statlysis-analysis-design-solve-two-problems-lazy-loading-and-scope</id>
    <content type="html"><![CDATA[<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># encoding: UTF-8</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># 统计分析DSL设计</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;singleton&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">StatlysisDslDesign</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">setup</span> <span class="o">&amp;</span><span class="n">block</span>
</span><span class='line'>      <span class="k">raise</span> <span class="s2">&quot;必须配置proc&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">block</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;开始配置 StatlysisDslDesign&quot;</span>
</span><span class='line'>      <span class="c1"># 1, 作用域   使用&amp;block把proc对象传递给其他对象作用域执行</span>
</span><span class='line'>      <span class="no">StatlysisDslDesign</span><span class="o">.</span><span class="n">time_log</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">config</span><span class="o">.</span><span class="n">push</span> <span class="n">block</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="nb">puts</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">process</span>
</span><span class='line'>      <span class="n">config</span><span class="o">.</span><span class="n">daily_crons</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">_proc</span><span class="o">|</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;开始执行 </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> 任务&quot;</span>
</span><span class='line'>        <span class="no">StatlysisDslDesign</span><span class="o">.</span><span class="n">time_log</span> <span class="k">do</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;结果 </span><span class="si">#{</span><span class="n">_proc</span><span class="o">.</span><span class="n">call</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">config</span>
</span><span class='line'>      <span class="no">Configuration</span><span class="o">.</span><span class="n">instance</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">protected</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">time_log</span>
</span><span class='line'>      <span class="n">t</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>      <span class="k">yield</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;时长 </span><span class="si">#{</span><span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">秒&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">42</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Configuration</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Singleton</span>
</span><span class='line'>    <span class="kp">attr_accessor</span> <span class="ss">:daily_crons</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">daily_crons</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">push</span> <span class="n">_proc</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">instance_exec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_proc</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">self</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">daily</span> <span class="n">symbol</span>
</span><span class='line'>      <span class="k">raise</span> <span class="s2">&quot;必须配置一个和symbol对应的proc&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">block_given?</span>
</span><span class='line'>      <span class="c1"># 2, 惰性加载 实现方法用proc包装block</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">daily_crons</span><span class="o">[</span><span class="n">symbol</span><span class="o">]</span> <span class="o">||=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="k">yield</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">StatlysisDslDesign</span><span class="o">.</span><span class="n">setup</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">daily</span> <span class="ss">:large_count</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">sleep</span> <span class="nb">rand</span>
</span><span class='line'>    <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">daily</span> <span class="ss">:slow_count</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">sleep</span> <span class="mi">3</span>
</span><span class='line'>    <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="no">StatlysisDslDesign</span><span class="o">.</span><span class="n">process</span>
</span><span class='line'>
</span><span class='line'><span class="cp">__END__</span>
</span><span class='line'><span class="cp">开始配置 StatlysisDslDesign</span>
</span><span class='line'><span class="cp">时长 0.0秒</span>
</span><span class='line'><span class="cp">------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="cp">开始执行 large_count 任务</span>
</span><span class='line'><span class="cp">结果 #&lt;struct count=10000000000&gt;</span>
</span><span class='line'><span class="cp">时长 0.57秒</span>
</span><span class='line'><span class="cp">------------------------------------------</span>
</span><span class='line'><span class="cp">开始执行 slow_count 任务</span>
</span><span class='line'><span class="cp">结果 #&lt;struct count=1&gt;</span>
</span><span class='line'><span class="cp">时长 3.0秒</span>
</span><span class='line'><span class="cp">------------------------------------------</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jQuery转义HTML]]></title>
    <link href="http://mvj3.github.io/2013/04/16/escape-html-by-jquery/"/>
    <updated>2013-04-16T14:45:54+08:00</updated>
    <id>http://mvj3.github.io/2013/04/16/escape-html-by-jquery</id>
    <content type="html"><![CDATA[<p>参考 <a href="http://stackoverflow.com/questions/6020714/escape-html-using-jquery">http://stackoverflow.com/questions/6020714/escape-html-using-jquery</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">escapeHTML</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div/&gt;&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">text</span><span class="p">).</span><span class="nx">html</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">escapeHTML</span><span class="p">(</span><span class="s1">&#39;&lt;div id=&quot;main&quot;&gt;&#39;</span><span class="p">);</span>
</span><span class='line'><span class="c1">// &quot;&amp;lt;div id=&quot;main&quot;&amp;gt;&quot;</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[XSS和CSRF的区别]]></title>
    <link href="http://mvj3.github.io/2013/04/05/the-difference-between-XSS-and-CSRF/"/>
    <updated>2013-04-05T20:22:49+08:00</updated>
    <id>http://mvj3.github.io/2013/04/05/the-difference-between-XSS-and-CSRF</id>
    <content type="html"><![CDATA[<p>XSS 是直接在源网站执行，如常见的如SQL注入和提交JS代码等。解决方法一般为把用户输入都作为不信任数据做转义处理。</p>

<p>CSRF 是破坏者间接利用了用户在源网站登陆情况下，在其他网站诱导用户触发JS请求获取源网站访问授权。Rails里用每次分配随机的 <code>csrf_meta_tag</code> 来解决伪造问题。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[给xunsearch提供一对多的不重复的数据列表]]></title>
    <link href="http://mvj3.github.io/2013/03/25/provide-Xunsearch-no-duplicated-one-to-many-data-list/"/>
    <updated>2013-03-25T14:07:30+08:00</updated>
    <id>http://mvj3.github.io/2013/03/25/provide-Xunsearch-no-duplicated-one-to-many-data-list</id>
    <content type="html"><![CDATA[<h2>问题概述</h2>

<p>同事采用的xunsearch搜索引擎在搜索一对多表时遇到了重复内容的问题，问题在通过SQL语句来生成的单表有因为一对多而导致的重复信息。简单google下，发现要用group_concat把两个表要用到的文本字段来把每个都合成到一行记录里，但是这样复杂的SQL估计只有大拿才能写的出来。</p>

<h2>解决方案</h2>

<p>于是我想到之前做的thinking-sphinx是支持一对多联合查询的，那就看看thinking-sphinx是如何来生成SQL的。</p>

<p>配置thinking-sphinx，这个参考官网。</p>

<p>code_gists对应多个code_documents，给搜索模块配置索引结构</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CodeGist</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">define_index</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">indexes</span> <span class="n">documents</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:content</span>
</span><span class='line'>    <span class="n">indexes</span> <span class="n">documents</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:content</span>
</span><span class='line'>    <span class="n">indexes</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:content</span>
</span><span class='line'>    <span class="n">indexes</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:content</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">where</span> <span class="s2">&quot;(code_gists.deleted_at IS NULL AND code_documents.deleted_at IS NULL)&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行bundle exec rake ts:config后，在config目录就有了config/production.sphinx.conf文件，察看source区块的sql_query为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">SQL_NO_CACHE</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="o">*</span> <span class="k">CAST</span><span class="p">(</span><span class="mi">3</span> <span class="k">AS</span> <span class="n">SIGNED</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span> <span class="k">AS</span> <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="p">,</span> <span class="n">GROUP_CONCAT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">IFNULL</span><span class="p">(</span><span class="o">`</span><span class="n">code_documents</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">filename</span><span class="o">`</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="n">SEPARATOR</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span> <span class="n">GROUP_CONCAT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">IFNULL</span><span class="p">(</span><span class="o">`</span><span class="n">code_documents</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="n">SEPARATOR</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">description</span><span class="o">`</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="k">AS</span> <span class="o">`</span><span class="n">sphinx_internal_id</span><span class="o">`</span><span class="p">,</span> <span class="mi">0</span> <span class="k">AS</span> <span class="o">`</span><span class="n">sphinx_deleted</span><span class="o">`</span><span class="p">,</span> <span class="mi">1875287073</span> <span class="k">AS</span> <span class="o">`</span><span class="n">class_crc</span><span class="o">`</span><span class="p">,</span> <span class="n">IFNULL</span><span class="p">(</span><span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">author</span><span class="o">`</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">author</span><span class="o">`</span> <span class="k">FROM</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="o">`</span><span class="n">code_documents</span><span class="o">`</span> <span class="k">ON</span> <span class="o">`</span><span class="n">code_documents</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">gist_id</span><span class="o">`</span> <span class="o">=</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="k">WHERE</span> <span class="p">(</span><span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="o">&gt;=</span> <span class="err">$</span><span class="k">start</span> <span class="k">AND</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="o">&lt;=</span> <span class="err">$</span><span class="k">end</span> <span class="k">AND</span> <span class="p">(</span><span class="n">code_gists</span><span class="p">.</span><span class="n">deleted_at</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">AND</span> <span class="n">code_documents</span><span class="p">.</span><span class="n">deleted_at</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">))</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">NULL</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>稍微整理后，变成</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">SQL_NO_CACHE</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">GROUP_CONCAT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">IFNULL</span><span class="p">(</span><span class="o">`</span><span class="n">code_documents</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">filename</span><span class="o">`</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="n">SEPARATOR</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">GROUP_CONCAT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">IFNULL</span><span class="p">(</span><span class="o">`</span><span class="n">code_documents</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="n">SEPARATOR</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span>
</span><span class='line'>                    <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">description</span><span class="o">`</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">IFNULL</span><span class="p">(</span><span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">author</span><span class="o">`</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span>
</span><span class='line'><span class="k">FROM</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span>
</span><span class='line'><span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="o">`</span><span class="n">code_documents</span><span class="o">`</span> <span class="k">ON</span> <span class="o">`</span><span class="n">code_documents</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">gist_id</span><span class="o">`</span> <span class="o">=</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span>
</span><span class='line'><span class="k">WHERE</span> <span class="p">(</span><span class="n">code_gists</span><span class="p">.</span><span class="n">deleted_at</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">AND</span> <span class="n">code_documents</span><span class="p">.</span><span class="n">deleted_at</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">)</span>
</span><span class='line'><span class="k">GROUP</span> <span class="k">BY</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行一下，就返回了不重复的数据列表了</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[独立使用HAML渲染]]></title>
    <link href="http://mvj3.github.io/2013/03/06/render-haml-independently/"/>
    <updated>2013-03-06T14:45:06+08:00</updated>
    <id>http://mvj3.github.io/2013/03/06/render-haml-independently</id>
    <content type="html"><![CDATA[<p>对于基本HAML语法可使用下列方法渲染即可</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">content</span>     <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">your_haml_path</span><span class="p">)</span>
</span><span class='line'><span class="n">engine</span>      <span class="o">=</span> <span class="ss">Haml</span><span class="p">:</span><span class="ss">:Engine</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">haml_content</span><span class="p">)</span>
</span><span class='line'><span class="n">engine</span><span class="o">.</span><span class="n">render</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果在content里使用了text_field_tag等view方法，那就需要在给engine指定render的作用域。默认是obj = Object.new，但是这个obj没有text_field_tag方法，所以就需要include ActionPack里对于的View模块，例如</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">HomeController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>   <span class="kp">include</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Helpers</span><span class="o">::</span><span class="no">AssetTagHelper</span>
</span><span class='line'>   <span class="kp">include</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Helpers</span><span class="o">::</span><span class="no">FormTagHelper</span>
</span><span class='line'>   <span class="kp">include</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Helpers</span><span class="o">::</span><span class="no">OutputSafetyHelper</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">engine</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="no">HomeController</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>参考文档</h2>

<ul>
<li><a href="http://haml.info/docs/yardoc/Haml/Engine.html">http://haml.info/docs/yardoc/Haml/Engine.html</a></li>
<li><a href="http://stackoverflow.com/questions/6125265/using-layouts-in-haml-files-independently-of-rails">http://stackoverflow.com/questions/6125265/using-layouts-in-haml-files-independently-of-rails</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails常见配置问题]]></title>
    <link href="http://mvj3.github.io/2013/03/06/rails-general-configuration-problems/"/>
    <updated>2013-03-06T10:42:41+08:00</updated>
    <id>http://mvj3.github.io/2013/03/06/rails-general-configuration-problems</id>
    <content type="html"><![CDATA[<h2>提示已经安装的gem不在Gemfile里</h2>

<p>最近有时遇到明明已经安装了rake，但是却提示我说有些gem没有在Gemfile里引用。比如：
Could not find rake-0.9.2.2 in any of the sources
Run &lsquo;bundle install&rsquo; to install missing gems.</p>

<p>我所使用的Ruby版本管理环境是rvm，查看下rvm info，发现ruby路径和gem管理路径不一致，因此rvm reload一下就解决了该问题。</p>

<p>rvm不一致的问题还需要查下，推测可能是开启多个SHELL，导致设置不一致～</p>

<h2>assets没有编译</h2>

<p>需要显示指定路径，在config/environments/production.rb里加入</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">precompile</span> <span class="o">+=</span> <span class="sx">%w[*js *css]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>development模式下刷新后静态资源不变</h2>

<p>删除public/assets目录下的缓存文件，这样就走动态请求了。</p>

<h2>修复rvm info里ruby版本不一致bug</h2>

<p>在/etc/profile里加一行rvm reload</p>

<h2>修复gem,irb等命令里老是提示ree某个版本的environment不存在</h2>

<p>修改该命令里的ruby环境路径到自己指定的版本</p>

<h2>修复默写外部css引用图片等静态资源不以/assets开头</h2>

<p>把资源及其路径直接拷到/public目录下</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Vim删除行末空格]]></title>
    <link href="http://mvj3.github.io/2013/02/26/delete-trailing-blank-in-vim/"/>
    <updated>2013-02-26T12:17:53+08:00</updated>
    <id>http://mvj3.github.io/2013/02/26/delete-trailing-blank-in-vim</id>
    <content type="html"><![CDATA[<p>在查看(View)模式下输入</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="p">:</span>%<span class="k">s</span><span class="sr">/\s\+$/</span><span class="k">g</span>
</span></code></pre></td></tr></table></div></figure>


<p>其实也即是删除了整行都是空格字符的。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby同时启动另一个进程]]></title>
    <link href="http://mvj3.github.io/2013/02/25/start-another-process-in-ruby/"/>
    <updated>2013-02-25T14:33:51+08:00</updated>
    <id>http://mvj3.github.io/2013/02/25/start-another-process-in-ruby</id>
    <content type="html"><![CDATA[<p>比如自动启动faye服务器, from <a href="http://stackoverflow.com/questions/6430437/autorun-the-faye-server-when-i-start-the-rails-server">http://stackoverflow.com/questions/6430437/autorun-the-faye-server-when-i-start-the-rails-server</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Thread</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;bundle exec rackup faye.ru -s thin -E production&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果是Rails/Rack，加入到项目根目录的config.ru，这样在执行console, rake, migration等其他操作时就不用启动这个进程了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby声明默认是空数组的Hash]]></title>
    <link href="http://mvj3.github.io/2013/02/18/declare-a-Hash-which-default-value-is-blank-array-in-ruby/"/>
    <updated>2013-02-18T12:13:50+08:00</updated>
    <id>http://mvj3.github.io/2013/02/18/declare-a-Hash-which-default-value-is-blank-array-in-ruby</id>
    <content type="html"><![CDATA[<p>Ruby里声明一个新Hash的方法一般是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">im_a_new_hash</span> <span class="o">=</span> <span class="p">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果给它设一个为0的默认值，可以</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">im_a_new_hash</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>变成一行语句就是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">im_a_new_hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是这里注意，这里的0其实是个唯一对象，即是每一个默认值的object_id都是一样的，比如</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">im_a_string_hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="s2">&quot;string&quot;</span> <span class="c1"># =&gt; {}</span>
</span><span class='line'><span class="n">im_a_string_hash</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="c1"># =&gt; &quot;string&quot;</span>
</span><span class='line'><span class="n">im_a_string_hash</span><span class="o">[</span><span class="mi">3</span><span class="o">].</span><span class="n">object_id</span> <span class="c1"># =&gt; 2168523080</span>
</span><span class='line'><span class="n">im_a_string_hash</span><span class="o">[</span><span class="mi">4</span><span class="o">].</span><span class="n">object_id</span> <span class="c1"># =&gt; 2168523080</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到取键3和4的默认值的object_id都是2168523080</p>

<p>Ruby里提供了new {|hash, key| block } → new_hash的方法, 因此声明一个默认是空数组的Hash的具体方法应该是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">im_a_default_array_hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">key</span><span class="o">|</span> <span class="nb">hash</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="o">[]</span> <span class="p">}</span> <span class="c1"># =&gt; {}</span>
</span><span class='line'><span class="n">im_a_default_array_hash</span><span class="o">[</span><span class="mi">99</span><span class="o">]</span> <span class="c1"># =&gt; []</span>
</span><span class='line'><span class="n">im_a_default_array_hash</span><span class="o">[</span><span class="mi">99</span><span class="o">].</span><span class="n">object_id</span> <span class="c1"># =&gt; 160533940</span>
</span><span class='line'><span class="n">im_a_default_array_hash</span><span class="o">[</span><span class="mi">99</span><span class="o">].</span><span class="n">object_id</span> <span class="c1"># =&gt; 160533940</span>
</span><span class='line'><span class="n">im_a_default_array_hash</span><span class="o">[</span><span class="mi">100</span><span class="o">].</span><span class="n">object_id</span> <span class="c1"># =&gt; 160571060 </span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到键99的值的object_id一直是160533940，而键100的值的object_id则是160571060</p>

<p>具体文档查看 <a href="http://www.ruby-doc.org/core-1.9.3/Hash.html#method-c-new">http://www.ruby-doc.org/core-1.9.3/Hash.html#method-c-new</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby的Dir.glob缓存BUG]]></title>
    <link href="http://mvj3.github.io/2013/02/18/Dir-glob-cache-bug-in-ruby/"/>
    <updated>2013-02-18T10:56:07+08:00</updated>
    <id>http://mvj3.github.io/2013/02/18/Dir-glob-cache-bug-in-ruby</id>
    <content type="html"><![CDATA[<p>Ruby的Dir.glob(&lsquo;/your/absolute/path/*&rsquo;)有缓存bug，新文件并不会返回，改成FileUtils.chdir后在Dir.glob(pattern)解决</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[关于《打造Facebook》第四章第七节 硅谷盛行的“工具文化”的一些思考]]></title>
    <link href="http://mvj3.github.io/2013/01/30/some-thoughts-about-of-tool-culture-after-reading-creating-facebook/"/>
    <updated>2013-01-30T20:57:59+08:00</updated>
    <id>http://mvj3.github.io/2013/01/30/some-thoughts-about-of-tool-culture-after-reading-creating-facebook</id>
    <content type="html"><![CDATA[<p>牛掰的技术公司在程序员里往往都是推崇的，Google, Facebook，等等，但这里面限于团队和文化因素，并不是所有公司都可以像他们那样，人多，人才多，给于的自由支配时间多。</p>

<h2>该章里提到的两类工具</h2>

<ul>
<li>平台型：动态分配开发机器资源，Git代码检查和代码规则，灰度发布，数据检测，用户报告和案例审察。</li>
<li>应用型：TODO list, 用户反馈自动分配，招聘测题，绩效考核（最后因专业难度的问题被替换了），考勤系统。</li>
</ul>


<h2>再来看看Facebook比较有名的开源框架</h2>

<p>Facebook是世界顶级的技术公司之一，做一定规模的云计算等不在话下，比如数据处理框架Hive，BigTable数据库cassandra，php编译框架hiphop，等等。</p>

<h2>工具和开源框架有什么区别？</h2>

<p>从技术难度上，工具难度一般远小于上面提及的开源项目。一家公司贡献开源项目，很大程度上是该公司业务里非核心竞争力技术对技术社区的贡献，比如Taobao。而工具，它像你平时配置的快捷键或常用脚本，个人性的东西比较强。</p>

<h2>看看工具文化推广的现实性</h2>

<p>互联网公司作为商业机构是靠业务盈利的，所以可以看到的情况是，除了做平台的，一般公司很少有精力和能力去开发专门的工具，作者王淮在该节最后也承认了，&#8221;相比面向用户的商品，让工程师去开发内部工具是需要去说服的。如果真正做到如此重视，最优秀的工程师是愿意加入工具团队的。”</p>

<h2>应用型工具文化推广的可能性</h2>

<p>不建议做，除非很多部门的大公司，比如facebook，做好业务最关键。因为已经有一些专业的人去做了，比如evernote，dropbox，等等。如果你是个人兴趣，想做一个开源的完备的，就另当别论了。</p>

<h2>平台型工具文化推广的可能性</h2>

<p>这是真正该做的，而且是鼓励做的。但是做之前先搜搜看是否已经有解决方案，上google，上github，或者code.eoe.cn ;)。如果没有，做完后尽量把它开源出来，让别人不用重新发明轮子，让更多更好的想法参与进来，说不定还能因此交上不错的朋友。目前Github上<a href="https://github.com/languages/Ruby" title="Ruby语言">Ruby</a>里最火的项目是什么呢？是一个叫做Homebrew的专门处理OSX软件库安装的包管理工具，大名鼎鼎的Rails Web框架正跟在它的后面，可见工具对解放人的生产力远大于业务上的。</p>

<p>所以，不用太拘泥于一定要学Facebook，写写<a href="http://blog.eoe.cn/" title="Blog">博客</a>总结自己的小技巧，分享一些不错的<a href="http://code.eoe.cn" title="代码">代码</a>，那样就够了。</p>

<p>本文存放在 <a href="http://code.eoe.cn/198">code.eoe.cn 的gist版本</a> 。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[最近访客实现]]></title>
    <link href="http://mvj3.github.io/2013/01/30/recent-visitors-implement/"/>
    <updated>2013-01-30T18:19:00+08:00</updated>
    <id>http://mvj3.github.io/2013/01/30/recent-visitors-implement</id>
    <content type="html"><![CDATA[<h2>问题分两个，一个是后端，一个是前端。</h2>

<p>对后端来说，用户每次blog/index|show访问都生成访问记录，后端需要进行排重和去掉未登陆用户。如果在该次访问里进行，特别是某个博客突然火了，必然每次访问都产生IO(磁盘或网络，因为多进程要共享信息），所以必定是异步的。</p>

<p>前端展示考虑到缓存，一般是页面片段缓存，或者ajax载入。</p>

<p>后端异步如何计算每个blog的最近访客，log.js记录了最近访问，一个后台常驻进程循环对日志表按时间记录来读取blog访问信息，把最近访客信息刷新。相对单次请求全部处理，这里处理次数更少，资源更节约，当然瓶颈也在日志表的索引更新和读取。</p>

<h2>把当前自己的访问也添加上</h2>

<p>上面唯一的缺陷是不能马上在当次访问里加上当前自己的访客信息，这个其实可以通过一个技巧来解决，那就是在浏览器里去把ajax获取来的访客列表加上自己的访客信息就OK了。两个注意点是排重和排除访问自己的页面。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[前端工程师的面试也可以如此生动]]></title>
    <link href="http://mvj3.github.io/2013/01/27/interview-frontend-engineer-can-also-be-so-vivid/"/>
    <updated>2013-01-27T22:43:49+08:00</updated>
    <id>http://mvj3.github.io/2013/01/27/interview-frontend-engineer-can-also-be-so-vivid</id>
    <content type="html"><![CDATA[<p>公司下半年因*.eoe.cn项目要开发上线，寻找合适的前端工程师势在必行。过程很坎坷，我翻了下自己的工作日志，招聘过程达三个月之久。来面试的有互联网公司的，培训学校的，同事推荐的，&hellip;，各种基本功薄弱的，薪资漫天要价的，不靠谱啊。最终相中了一个工作两三年的，在偏时尚媒体设计公司待过的女前端工程师。</p>

<p>面试是和其他同事一起进行的，除了对品性和工作方式的考察外，专业方面看的还是基础知识和经验。前端工程师一般分两类，一种是设计+CSS，关键词也就是Dreamweaver+Photoshop，这种人较多，但通常计算机知识薄弱。另一种是JS+CSS，偏重浏览器内的MVC, 这种人比较少，也是业界稀缺的。可能有人会说两者都包的人，那这种人是全才，基本都可以去创业了。我本身是Ruby(Rails）后端背景的，对前端略懂，而浏览器兼容性几乎没接触过。因此面试偏CSS的不太容易问出什么，也就是面试宝典里的绝对定位法，inline和block区别，jQuery选择器优化，等之类的。</p>

<p>一个偶然的机会，在问到一个前来面试的觉得国内有哪些觉得不错的前端产品的时候，有人提到了网易的新闻聚合（见下图news.tags.163.png），它采用了不同大小矩形色块的TreeMap可视化方式展现了新闻资讯集合。从源码上说，它只有不到150行的规整的HTML结构，足够在短时间内把握。让我们边看这个网页边面试：</p>

<ol>
<li> 点击右上角的刷新按钮后，每个资讯元素重新滑动排列，这里可以考察HTML5的CSS，下面的&#8221;今天, 三天，一周&#8221;的时间范围的切换也是。</li>
<li> 在这里还可以去问这些元素是重新排列，还是从服务器端获取的，可以让对方去源码里找出是哪一行还是引用的文件里调用了ajax。</li>
<li> 打开chrome的调试器，并点击Network标签，在重新加载后，有些请求的Status变成了304，有些Size变成了from cache，这里可以去考察HTTP常识。</li>
<li> 刚才我们翻开了HTML源码，问下css引用链接在上而js引用在下的原因，考察浏览器的渲染顺序。</li>
<li> 接着我们又发现新闻数据并没有在HTML里看到，看对方是否可以知晓js如何调用。</li>
<li> 看过css后，我们发现一个script标签里的type是text/x-micro-template，问下这是干什么的。如果对方回答出模版后，可以再去模版的实现原理，这样就实际就考察了对js闭包的了解。</li>
<li> js代码里面有些英文单词，可以趁机考考英文水平，很多工程师都没听说过github的。</li>
</ol>


<p>问到这里的时候，水平自然见分晓了。这种方式虽然系统考察了一个前端该具备的技术能力，但事后证明它会让某些在CSS方面不错的和能实际快速的干活的人才错过了。
对一般的互联网团队来说，1, CSS命名的规范结构化，2, 严格遵守jQuery链式调用规范，而不是一大堆东抄西补的原生js，3, 和快速的动手能力，前端工程师的这三点才是最重要的。</p>

<p>Android技术招聘可参看@iceskysl 的 <a href="http://my.eoe.cn/iceskysl/archive/21.html">说说我招聘android技术人员的思路</a> ，里面提到的4个点对招聘一般的应用工程师其实都适用。</p>

<p>本文存放在 <a href="http://code.eoe.cn/145">code.eoe.cn 的gist版本</a> 。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[*.eoe.cn制作代码大爆炸！]]></title>
    <link href="http://mvj3.github.io/2013/01/26/create-a-code-bang-for-eoecn/"/>
    <updated>2013-01-26T16:44:15+08:00</updated>
    <id>http://mvj3.github.io/2013/01/26/create-a-code-bang-for-eoecn</id>
    <content type="html"><![CDATA[<p><img src="http://mvj3.github.io/images/imovie.png" alt="imovie" /></p>

<p>下载安装code swarm，系统环境预备见<a href="https://github.com/rictic/code_swarm">https://github.com/rictic/code_swarm</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone git://github.com/rictic/code_swarm.git <span class="o">&amp;&amp;</span> <span class="nb">cd </span>code_swarm <span class="c"># 下载源码</span>
</span><span class='line'>ant <span class="c"># 编译</span>
</span></code></pre></td></tr></table></div></figure>


<p>合并多个git仓库</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir eoecn_codebang <span class="o">&amp;&amp;</span> <span class="nb">cd </span>eoecn_codebang <span class="c"># 创建临时仓库目录，并切换</span>
</span><span class='line'>git init <span class="o">&amp;&amp;</span> git commit --allow-empty-message -am <span class="s1">&#39;&#39;</span> --allow-empty <span class="c"># 初始化git环境</span>
</span><span class='line'>git remote add programmingonline git@eoe.git.server:/opt/datas/git/eoe/programming.online.git <span class="c"># 添加多个git仓库</span>
</span><span class='line'>git remote add eoecn git@eoe.git.server:/opt/datas/git/eoe/eoecn.git
</span><span class='line'>git pull programmingonline master <span class="c"># 合并多个git仓库</span>
</span><span class='line'>git pull eoecn master
</span><span class='line'>git commit -am <span class="s1">&#39;merge programmingonline and eoecn&#39;</span> <span class="c"># 直接合并冲突</span>
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/Users/mvj3/github/rictic/code_swarm/bin:$PATH&quot;</span> <span class="c"># 把code_swarm的bin目录加入到环境变</span>
</span><span class='line'>量中
</span><span class='line'>code_swarm <span class="c"># 不用管他出错提示，只要在运行就可以了。它会在当前目录下生成包含git历史记录信息的.code_swarm/log.xml</span>
</span><span class='line'>ruby -e <span class="s1">&#39;filename = &quot;/Users/mvj3/eoemobile/code/eoecn_codebang/.code_swarm/log.xml&quot;; File.write(filename, File.read(filename).gsub(/@[^&quot;]*\&quot;/,&quot;\&quot;&quot;))&#39;</span> <span class="c"># 在ruby里把无效的email后缀去除。</span>
</span></code></pre></td></tr></table></div></figure>


<p>生成一帧一帧的png文件</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">pwd</span>   <span class="c">#  先切换回code_swarm项目目录，修改defaults/user.config里的InputFile变量到刚才生成的.code_swarm/log.xml的绝对路径</span>
</span><span class='line'>./run.sh defaults/user.config <span class="c"># 如果没错误的话，你就可以frames目录下不断有png生成了。如果量大的话，你会听到电脑的风扇也在狂转了。</span>
</span></code></pre></td></tr></table></div></figure>


<p>用iMovie制作视频</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ffmpeg -f image2 -r 12 -i ./frames/code_swarm-%05d.png -sameq ./out.mov -pass 2 <span class="c"># 用ffmpeg生成视频，直接iMovie导入这么多png太慢</span>
</span></code></pre></td></tr></table></div></figure>


<h3>iMovie使用总结</h3>

<p>任何视频，音频，字幕操作都是选中后操作，包括时长，大小，变速等。</p>

<h3>参考文档</h3>

<ul>
<li><a href="http://code.google.com/p/codeswarm/wiki/GeneratingAVideo#Instructions_for_running_Codeswarm_0.1_on_OS_X_10.6_with_a_git_r">http://code.google.com/p/codeswarm/wiki/GeneratingAVideo#Instructions_for_running_Codeswarm_0.1_on_OS_X_10.6_with_a_git_r</a></li>
<li><a href="http://progressdaily.diandian.com/post/2012-01-20/14242590">http://progressdaily.diandian.com/post/2012-01-20/14242590</a></li>
</ul>


<p>附上配置文件 user.config</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Your personal preferences for code_swarm, applied to every visualization</span>
</span><span class='line'><span class="c"># you run, unless overridden by the individual visualization&#39;s config</span>
</span><span class='line'>
</span><span class='line'><span class="c">#DON&#39;T EDIT THIS FILE IN PLACE, FIRST COPY IT TO defaults/user.config</span>
</span><span class='line'><span class="c">#CHANGES TO THIS FILE WON&#39;T BE SEEN BY code_swarm, ONLY user.config</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Some common options to customize:</span>
</span><span class='line'>
</span><span class='line'><span class="c"># It&#39;s much faster if we can use OpenGL, but it still doesn&#39;t work on some</span>
</span><span class='line'><span class="c"># platforms/configurations</span>
</span><span class='line'><span class="nv">UseOpenGL</span><span class="o">=</span><span class="nb">true</span>
</span><span class='line'>
</span><span class='line'><span class="c"># The size of the visualization window</span>
</span><span class='line'><span class="nv">Width</span><span class="o">=</span>640
</span><span class='line'><span class="nv">Height</span><span class="o">=</span>280
</span><span class='line'>
</span><span class='line'><span class="nv">Font</span><span class="o">=</span>Helvetica
</span><span class='line'><span class="nv">FontSize</span><span class="o">=</span>25
</span><span class='line'><span class="nv">BoldFontSize</span><span class="o">=</span>20
</span><span class='line'><span class="nv">TakeSnapshots</span><span class="o">=</span><span class="nb">true</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Size in pixels of the width and height of avatar images</span>
</span><span class='line'><span class="nv">AvatarSize</span><span class="o">=</span>64
</span><span class='line'>
</span><span class='line'><span class="nv">InputFile</span><span class="o">=</span>/Users/mvj3/eoemobile/code/eoecn_codebang/.code_swarm/log.xml
</span><span class='line'><span class="nv">SnapshotLocation</span><span class="o">=</span>frames/code_swarm-#####.png
</span><span class='line'><span class="c">#For more options, see defaults/code_swarm.config</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># Draw names (combinatory) :</span>
</span><span class='line'><span class="c"># Draw sharp names?</span>
</span><span class='line'><span class="nv">DrawNamesSharp</span><span class="o">=</span><span class="nb">true</span>
</span><span class='line'><span class="c"># And draw a glow around names? (Runs slower)</span>
</span><span class='line'><span class="nv">DrawNamesHalos</span><span class="o">=</span><span class="nb">false</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Draw files (combinatory) :</span>
</span><span class='line'><span class="c"># Draw sharp files</span>
</span><span class='line'><span class="nv">DrawFilesSharp</span><span class="o">=</span><span class="nb">false</span>
</span><span class='line'><span class="c"># Draw fuzzy files</span>
</span><span class='line'><span class="nv">DrawFilesFuzzy</span><span class="o">=</span><span class="nb">true</span>
</span><span class='line'><span class="c"># Draw jelly files</span>
</span><span class='line'><span class="nv">DrawFilesJelly</span><span class="o">=</span><span class="nb">false</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Show the Legend at start</span>
</span><span class='line'><span class="nv">ShowLegend</span><span class="o">=</span><span class="nb">false</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Show the History at start</span>
</span><span class='line'><span class="nv">ShowHistory</span><span class="o">=</span><span class="nb">true</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Show the Date at start</span>
</span><span class='line'><span class="nv">ShowDate</span><span class="o">=</span><span class="nb">true</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Show edges between authors and files, mostly for debug purpose</span>
</span><span class='line'><span class="nv">ShowEdges</span><span class="o">=</span><span class="nb">false</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Turn on Debug counts.</span>
</span><span class='line'><span class="nv">ShowDebug</span><span class="o">=</span><span class="nb">false</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Natural distance of files to people</span>
</span><span class='line'><span class="nv">EdgeLength</span><span class="o">=</span>25
</span><span class='line'>
</span><span class='line'><span class="c"># Amount of life to decrement</span>
</span><span class='line'><span class="nv">EdgeDecrement</span><span class="o">=</span>-2
</span><span class='line'><span class="nv">FileDecrement</span><span class="o">=</span>-2
</span><span class='line'><span class="nv">PersonDecrement</span><span class="o">=</span>-1
</span><span class='line'>
</span><span class='line'><span class="c">#Speeds.</span>
</span><span class='line'><span class="c">#Optional: NodeSpeed=7.0, If used, FileSpeed and PersonSpeed need not be set.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="nv">FileSpeed</span><span class="o">=</span>7.0
</span><span class='line'><span class="nv">PersonSpeed</span><span class="o">=</span>2.0
</span><span class='line'>
</span><span class='line'><span class="c">#Masses</span>
</span><span class='line'><span class="nv">FileMass</span><span class="o">=</span>1.0
</span><span class='line'><span class="nv">PersonMass</span><span class="o">=</span>10.0
</span><span class='line'>
</span><span class='line'><span class="c"># Life of an Edge</span>
</span><span class='line'><span class="nv">EdgeLife</span><span class="o">=</span>250
</span><span class='line'>
</span><span class='line'><span class="c"># Life of a File</span>
</span><span class='line'><span class="nv">FileLife</span><span class="o">=</span>200
</span><span class='line'>
</span><span class='line'><span class="c"># Life of a Person</span>
</span><span class='line'><span class="nv">PersonLife</span><span class="o">=</span>255
</span><span class='line'>
</span><span class='line'><span class="c"># Highlight percent.</span>
</span><span class='line'><span class="c"># This is the amount of time that the person or</span>
</span><span class='line'><span class="c"># file will be highlighted.</span>
</span><span class='line'><span class="nv">HighlightPct</span><span class="o">=</span>5
</span><span class='line'>
</span><span class='line'><span class="c">## Physics engine selection and configuration</span>
</span><span class='line'><span class="c"># Directory physics engine config files reside in.</span>
</span><span class='line'><span class="nv">PhysicsEngineConfigDir</span><span class="o">=</span>physics_engine
</span><span class='line'><span class="c"># Force calculation algorithms (&quot;PhysicsEngineLegacy&quot;, &quot;PhysicsEngineSimple&quot;...) :</span>
</span><span class='line'><span class="nv">PhysicsEngineSelection</span><span class="o">=</span>PhysicsEngineOrderly
</span><span class='line'>
</span><span class='line'><span class="c">#Is the input xml sorted by date?  It&#39;s faster and uses much less memory if it is</span>
</span><span class='line'><span class="nv">IsInputSorted</span><span class="o">=</span><span class="nb">true</span>
</span><span class='line'>
</span><span class='line'><span class="c"># OpenGL is experimental. Use at your own risk.</span>
</span><span class='line'><span class="nv">UseOpenGL</span><span class="o">=</span><span class="nb">false</span>
</span><span class='line'><span class="nv">ShowUserName</span><span class="o">=</span><span class="nb">true</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
</feed>
