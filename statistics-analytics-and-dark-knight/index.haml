<!-- 运行方法 haml index.haml > index.html -->
!!!
%html
  %head
    %meta{:charset => "utf-8"}
    %meta{:name => "viewport", :content => "width=1024"}
    %meta{:name => "apple-mobile-web-app-capable", :content => "yes"}
    %meta{:name => "description", :content => "统计分析与黑暗骑士"}
    %meta{:name => "author", :content => "陈大伟"}
    %title 统计分析与黑暗骑士
    <link href="/favicon.png" rel="icon">
    <link href="stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script src="javascripts/modernizr-2.0.js"></script>
    <script src="javascripts/jquery.min.js" type="text/javascript"></script>
    <script src="javascripts/octopress.js" type="text/javascript"></script>


  %body{:class => "impress-not-supported", :style => "display:none;"}
    .fallback-message
      %p 你的浏览器不支持，请使用chrome或safari浏览本网页。此幻灯片在苹果的chrome里呈现效果最好。
    #impress
      .step{:id => "start", :"data-x" => "-2000", :"data-y" => "-2000", :"data-rotate" => "180", :"data-scale" => "1"}
        %div{:style => "font-size:150px;font-weight:bold;"}
          %span.c_statistics 统计
          %span.c_analytics 分析
        %div{:style => "color:#032E3F;margin-left:600px;margin-top:200px;"} 陈大伟
        %div{:style => "color:#032E3F;margin-left:220px;margin-top:20px;"} 优亿数据统计分析负责人
        %div{:style => "color:#032E3F;margin-left:400px;margin-top:20px;"}
          %a{:href => "http://weibo.com/mvj3"} weibo.com/mvj3
        %div{:style => "color:#032E3F;margin-left:500px;margin-top:20px;"} 2012-07-29

      .step.statistics{:"data-x" => "-4000", :"data-y" => "0", :"data-rotate" => "180", :"data-scale" => "2"}
        .batman_s{:style => "background-image:url(images/big_data.jpg)"}
        %h2.c_statistics{:style => "margin-left:60px;"} 如何呈现大数据
      .step.statistics{:"data-x" => "-4000", :"data-y" => "-2000", :"data-rotate" => "180", :"data-scale" => "2"}
        .batman_s{:style => "background-image:url(images/three_demissions.jpg)"}
        %h2.c_statistics{:style => "margin-left:60px;"} 实时 + 多维
      .step{:"data-x" => "-4000", :"data-y" => "-5000", :"data-rotate" => "180", :"data-scale" => "2"}
        %ul.c_statistics
          %li 统计表结构为 {:time => Time, :app_id => Integer, :channel_id => Integer, :count => Integer}
          %li SQL查询 => ORM实例化 => 二维矩阵 => 图表展示
          %li 相同数据量下磁盘的访问速度比内存延迟三个以上数量级
      .step{:id => "matrx", :"data-x" => "-6000", :"data-y" => "-4000", :"data-rotate" => "180", :"data-scale" => "2", :style => "width:900px;height:640px;"}
        .c_statistics 填充图表数据的两种方式
        %input.btn{:type => "button", :value => "完整保存各个维度", :id => "full"}
        %input.btn{:type => "button", :value => "只存非零的，即有下载的", :id => "sparse"}
        %table.table.table-striped{:id => "table_full", :style=>"table-layout:fixed;display:none;font-size:15px;"}
          %tbody
            %thead
              %th 某应用
              - (1..10).each do |num|
                %th= "#{num}号"
            %tbody
              - @v_idx = 0
              - (1..10).each do |channel_id|
                %tr
                  %td= "渠道#{channel_id}"
                  - (1..10).each do |num|
                    %td{:id => "tf_#{@v_idx}"}
                    - @v_idx += 1;
        %table.table.table-striped{:id => "table_sparse", :style=>"table-layout:fixed;display:none;font-size:15px;"}
          %tbody
            %thead
              %th 某应用
              - (1..10).each do |num|
                %th= "#{num}号"
            %tbody
              - @v_idx = 0
              - (1..10).each do |channel_id|
                %tr
                  %td= "渠道#{channel_id}"
                  - (1..10).each do |num|
                    %td{:id => "ts_#{@v_idx}"} 0
                    - @v_idx += 1;


      .step.statistics{:"data-x" => "2000", :"data-y" => "4000", :"data-rotate" => "180", :"data-scale" => "2"}
        .batman_a{:style => "background-image:url(images/clown.jpg);width:800px;"}
        .c_analytics
          %span{:style => "margin-left:-70px;"} 又有人开始刷量了！！！

      .step.statistics{:"data-x" => "2000", :"data-y" => "6000", :"data-rotate" => "180", :"data-scale" => "2"}
        .batman_a{:style => "background-image:url(images/1.jpg)"}
        .c_analytics
          %h2 1. 收集原始数据
          %ul
            %li 最大限度保全信息，包括下载时间，IP，User-Agent和Referer等HTTP头信息，应用ID，客户端，渠道，唯一码等设备信息
            %li 在日志写入后尽快入库，否则可能会被系统删除等
            %li 数据量占用空间足够小
      .step.statistics{:"data-x" => "2000", :"data-y" => "8000", :"data-rotate" => "180", :"data-scale" => "2"}
        .batman_a{:style => "background-image:url(images/2.jpg)"}
        .c_analytics
          %h2 2. 数据分类
          %ul
            %li 使用Mongodb的MapReduce功能进行多维数据统计。简单的说就是把计算分散到多机器多进程, 原理介绍参见http://zh.wikipedia.org/wiki/MapReduce
      .step.statistics{:"data-x" => "2000", :"data-y" => "10000", :"data-rotate" => "180", :"data-scale" => "2"}
        .batman_a{:style => "background-image:url(images/3.jpg)"}
        .c_analytics
          %h2 3. 数据对比
          %ul
            %li 比较各个MapReduce结果，察看哪个更符合特定的刷量模式
      .step.statistics{:"data-x" => "2000", :"data-y" => "12000", :"data-rotate" => "180", :"data-scale" => "2"}
        .batman_a{:style => "background-image:url(images/4.jpg)"}
        .c_analytics
          %h2 4. 数据建模
          %ul
            %li 保存各个维度的分析数据到不同的统计表
      .step.statistics{:"data-x" => "2000", :"data-y" => "14000", :"data-rotate" => "180", :"data-scale" => "2"}
        .batman_a{:style => "background-image:url(images/5.jpg)"}
        .c_analytics
          %h2 5. 特征值组合
          %ul
            %li 比如 User-Agent相比其他正常应用分布均匀; 没有客户端, 渠道, 唯一码等信息
      .step.statistics{:"data-x" => "2000", :"data-y" => "16000", :"data-rotate" => "180", :"data-scale" => "2"}
        .batman_a{:style => "background-image:url(images/6.jpg)"}
        .c_analytics
          %h2 6. 确定结果
          %ul
            %li 把怀疑为刷量应用的列表展示在后台，方便运营人员对该应用做警告或下架等处理


      .step{:id => "end", :"data-x" => "-2000", :"data-y" => "2000", :"data-rotate" => "180", :"data-scale" => "1", :style => "color:#032E3F;"}
        %h2 感谢
        %ul
          %li
            %a{:href => "https://github.com/bartaz/impress.js/"} impress.js
          %li
            %a{:href => "http://movie.douban.com/subject/1851857/"} 蝙蝠侠前传2：黑暗骑士 The Dark Knight (2008)
          %li
            %a{:href => "http://www.evanmiller.org/nginx-modules-guide.html"} Emiller's Guide To Nginx Module Development
          %li 巴赫《马太受难曲》
          %li
            %a{:href => "http://www.colourlovers.com/"} Color Trends + Palettes :: COLOURlovers

      .hint 使用空格键或方向键进行浏览


    <script src="javascripts/impress.js" type="text/javascript"></script>
    <link href="stylesheets/impress-demo.css" rel="stylesheet" type="text/css">
    :css
       #impress .step ul li {
         font-size: 30px;
       }
       .btn {
         font-size: 40px;
       }
       #start {
         text-align: center;
         line-height: 1;
       }
       .statistics {
         height: 700px;
         width: 900px;
         background: #032E3F;
       }
       .batman_s {
         padding: 250px 200px;
         background-size: 700px 450px;;
         background-position: center;
         background-repeat: no-repeat;
       }
       .batman_a {
         width: 600px;
         height: 400px;
         background-position: center;
         background-repeat: no-repeat;
         background-size: 700px 450px;;
       }
       .c_statistics {
         color: #FF6D06;
       }
       ul.c_statistics li {
         font-size: 30px;
       }
       .c_analytics {
         color: #097C86;
         padding-left: 120px;
       }
       .step {
         font-family: Helvetica;
       }
       .rightFace,
       .leftFace,
       .topFace,
       .backRightFace,
       .backLeftFace,
       .bottomFace {
         width: 700px;
         height: 700px;
         background: #032E3F;
       }
       .cube .step .c_analytics {
         margin-left: -120px;
       }
       ul {
         list-style: circle;
       }
       .cube .step .c_analytics ul {
         margin-left: 30px;
       }
       .cube .step .c_analytics ul li {
         font-size: 20px;
       }

       table th, table td {
         width: 130px;
         font-size: 25px;
       }
    :javascript
      $(document).ready(function() {
        $("body").show();
        impress().init();

        var data = [[2, 0, 0, 2, 2, 2, 0, 1, 3, 3], [10, 6, 4, 7, 4, 3, 5, 3, 7, 1], [1, 4, 6, 7, 5, 3, 2, 3, 1, 0], [105, 100, 92, 99, 99, 89, 120, 91, 105, 103], [1, 0, 0, 0, 0, 0, 0, 0, 0, 0], [8, 3, 3, 10, 5, 6, 10, 7, 5, 4], [9, 5, 4, 3, 6, 7, 8, 4, 9, 8], [1, 0, 0, 0, 0, 0, 3, 2, 0, 0], [1, 0, 0, 0, 0, 0, 0, 0, 0, 0], [186, 177, 170, 184, 185, 176, 189, 161, 183, 158]];
        data = $.map(data, function(n) { return n });
        $("#full").click(function() {
          $("#table_sparse").hide();
          $('#table_full td[id^="tf_"]').text('');
          $("#table_full").show().delay(1000).css("class", "test"); // delay 1s please.
          var delay_count = 0;
          $.each(data, function(idx, n) {
            if (idx % 10 == 0) { delay_count += 1 };
            setTimeout(function() {
              $('#table_full td#tf_' + idx).text(n); // .effect('highlight');
            }, 500*delay_count);
          });
        });
        $("#sparse").click(function() {
          $("#table_full").hide();
          $('#table_sparse td[id^="ts_"]').text('0');
          $("#table_sparse").show().delay(1000).css("class", "test");
          var delay_count = 0;
          $.each(data, function(idx, n) {
            if (n != 0) {
              delay_count += 1;
              setTimeout(function() {
                $('#table_sparse td#ts_' + idx).text(n); // .effect('highlight');
              }, 300*delay_count);
            }
          });
        });


        // GA
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-33744316-1']);
        _gaq.push(['_trackPageview']);
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

      });
