
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>世界的审美！</title>
    <meta name="author" content="mvj3">
    
	<meta name="description" content="Published on: Dec 31st, 2011 Tags: Mongodb, Mongoid 1
Object.constants.map(&amp;:constantize).select {|c| c.included_modules.include?(Mongoid:: &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="世界的审美！" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    
    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-19059295-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        mvj3
    </div>
</h1>
<br>

<ul id="social-links" style="text-align:center">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/mvj3" class="github" title="Github"></a>
  </li>
  
  
  <!-- Google Plus -->
  <li>
  <a href="http://plus.google.com/112424697046854998838?rel=author" class="google" title="Google+"></a>
  </li>
  
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/mvj3" class="twitter" title="Twitter"></a>
  </li>
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/12/31/rebuild-all-mongoid-collections-indexes/">
		
			整个项目的mongoid表重建索引</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-12-31T16:45:09+08:00" pubdate data-updated="true">Dec 31<span>st</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/mongodb/'>Mongodb</a>, <a class='category' href='/blog/categories/mongoid/'>Mongoid</a>


</div>
    </div>
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Object</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:constantize</span><span class="p">)</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="o">.</span><span class="n">included_modules</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span><span class="p">)</span> <span class="k">rescue</span> <span class="kp">nil</span> <span class="p">}</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:create_indexes</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/12/31/rebuild-all-mongoid-collections-indexes//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/12/19/compare-memory-usage-after-init-between-redis-and-memcached/">
		
			Redis和memcached初始化内存比较</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-12-19T16:45:09+08:00" pubdate data-updated="true">Dec 19<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/io/'>IO</a>, <a class='category' href='/blog/categories/memcached/'>memcached</a>, <a class='category' href='/blog/categories/redis/'>redis</a>


</div>
    </div>
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ redis-stat
</span><span class='line'>------- data ------ --------------------- load -------------------- - child -
</span><span class='line'>keys       mem      clients blocked requests            connections
</span><span class='line'>3          1.30M    1       0       150000 (+150000)    751
</span><span class='line'>3          1.30M    1       0       150001 (+1)         751
</span><span class='line'>3          1.30M    1       0       150002 (+1)         751
</span><span class='line'>
</span><span class='line'>$ ps -ef | grep memc
</span><span class='line'>  501 28585     1   0   0:00.00 ??         0:00.00 memcached -d
</span><span class='line'>  501 28596 15675   0   0:00.00 ttys010    0:00.00 grep memc
</span><span class='line'>$ vmmap 28585 | tail -n 2
</span><span class='line'>DefaultMallocZone_0x100065000      18.0M        179      1235K      6%
</span></code></pre></td></tr></table></div></figure>


<p>redis默认比memcachd低多了</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/12/19/compare-memory-usage-after-init-between-redis-and-memcached//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/11/15/Fix-yum-Error-requested-datatype-primary-not-available/">
		
			解决yum错误Error: Requested Datatype Primary Not Available</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-11-15T16:45:09+08:00" pubdate data-updated="true">Nov 15<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/centos/'>CentOS</a>, <a class='category' href='/blog/categories/yum/'>yum</a>


</div>
    </div>
		<h2>服务器信息</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>[mvj3@sdk2 ~]$ cat /proc/version
</span><span class='line'>Linux version 2.6.18-194.el5 (mockbuild@ca-build10.us.oracle.com) (gcc version 4.1.2 20080704 (Red Hat 4.1.2-48)) #1 SMP Mon Mar 29 22:10:29 EDT 2010
</span></code></pre></td></tr></table></div></figure>


<h2>出错信息</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>[mvj3@sdk2 ~]$ sudo yum install gettext-devel httpd-devel openssl-devel zlib-devel gcc gcc-c++ curl-devel expat-devel gettext-devel mysql-server mysql-devel libevent-devel mysql-devel mysql pcre pcre-devel libxml2-devel sqlite-devel ruby-devel -y
</span><span class='line'>Loaded plugins: security
</span><span class='line'>Error: requested datatype primary not available
</span><span class='line'>[mvj3@sdk2 ~]$ sudo yum upgrade
</span><span class='line'>Loaded plugins: security
</span><span class='line'>Error: requested datatype primary not available
</span></code></pre></td></tr></table></div></figure>


<h2>解决方案</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>[mvj3@sdk2 ~]$ sudo yum clean all
</span><span class='line'>Loaded plugins: security
</span><span class='line'>Cleaning up Everything
</span><span class='line'>[mvj3@sdk2 ~]$ sudo rpm --rebuilddb
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/11/15/Fix-yum-Error-requested-datatype-primary-not-available//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/11/03/mongodb-delete-duplicated-data/">
		
			Mongodb删除重复数据</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-11-03T16:49:38+08:00" pubdate data-updated="true">Nov 3<span>rd</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/index/'>Index</a>, <a class='category' href='/blog/categories/mongodb/'>Mongodb</a>, <a class='category' href='/blog/categories/statistical/'>Statistical</a>


</div>
    </div>
		<p>统计分析需要跑各个时间粒度的任务，如果异常中断后重新选择某个时间删除后再跑的时候，有时候还是会有重复的统计数据。</p>

<p>在mongodb中建立唯一索引时加上dropDups选项可以解决此问题：</p>

<p>A unique index cannot be created on a key that has pre-existing duplicate values. If you would like to create the index anyway, keeping the first document the database indexes and deleting all subsequent documents that have duplicate values, add the dropDups option</p>

<p><a href="http://www.mongodb.org/display/DOCS/indexes#Indexes-dropDups">http://www.mongodb.org/display/DOCS/indexes#Indexes-dropDups</a></p>

<p>Mongoid对应的参数配置是 , :unique => true, :background => true, :dropDups => true</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/11/03/mongodb-delete-duplicated-data//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/11/03/exception_notification_rails3-doesnot-send-mail/">
		
			Exception_notification_rails3没有发邮件</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-11-03T16:45:09+08:00" pubdate data-updated="true">Nov 3<span>rd</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/gem/'>Gem</a>, <a class='category' href='/blog/categories/mail/'>Mail</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>


</div>
    </div>
		<p>Rails项目里同事发现配置的 exception_notification_rails3 没有正常的发出异常错误邮件</p>

<p>对比了下我这边正常的配置，把config.middleware.use ExceptionNotifier 放到config/application.rb里最后就可以了，虽然没有从源码里看出问题来 = =</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/11/03/exception_notification_rails3-doesnot-send-mail//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/10/20/install-nokogiri-locally-on-centos/">
		
			CentOS本地安装nokogiri</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-10-20T16:45:09+08:00" pubdate data-updated="true">Oct 20<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/centos/'>CentOS</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>, <a class='category' href='/blog/categories/nokogiri/'>nokogiri</a>


</div>
    </div>
		<p>帮同事在一台centos上安装nokogiri，记载如下：</p>

<p>系统信息：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>[root@localhost ~]# uname -a
</span><span class='line'>Linux localhost.localdomain 2.6.18-194.el5 #1 SMP Fri Apr 2 14:58:14 EDT 2010 x86_64 x86_64 x86_64 GNU/Linux
</span><span class='line'>[root@localhost ~]# cat /proc/version
</span><span class='line'>Linux version 2.6.18-194.el5 (mockbuild@builder10.centos.org) (gcc version 4.1.2 20080704 (Red Hat 4.1.2-48)) #1 SMP Fri Apr 2 14:58:14 EDT 2010
</span></code></pre></td></tr></table></div></figure>


<p>卸载并重新安装nokogiri依赖的C库：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo yum remove -y libxml2-devel libxslt-devel
</span><span class='line'>sudo yum install -y libxml2-devel libxslt-devel
</span></code></pre></td></tr></table></div></figure>


<p>最近rubygems.org的在amazon的代码库索引源访问极慢，无奈只能把本地安装过的gems压缩包全部拷上去
scp /usr/local/rvm/gems/ree-1.8.7-2011.03/cache/*gem root@host:~/gems/
然后在服务器上执行 sudo gem i nokogiri-1.5.0.gem  -l 即可</p>

<p>测试代码如下，nokogiri已能正常解析HTML了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="sx">%w[nokogiri open-uri]</span><span class="o">.</span><span class="n">map</span> <span class="o">&amp;</span><span class="nb">method</span><span class="p">(</span><span class="ss">:require</span><span class="p">)</span>
</span><span class='line'><span class="n">resp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;http://www.douban.com&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'><span class="nb">puts</span> <span class="ss">Nokogiri</span><span class="p">:</span><span class="ss">:HTML</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s2">&quot;body .article .content&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/10/20/install-nokogiri-locally-on-centos//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/10/09/fix-sqlite3-version-compatibility-problem-on-centos/">
		
			CentOS上sqlite3版本兼容问题</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-10-09T16:41:53+08:00" pubdate data-updated="true">Oct 9<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/centos/'>CentOS</a>, <a class='category' href='/blog/categories/sqlite3/'>Sqlite3</a>


</div>
    </div>
		<h2>问题</h2>

<p>sqlite3-ruby的1.3版本在CentOS不兼容，访问数据库时报如下错误：
/usr/local/ruby/ruby-enterprise-1.8.7-2011.03/bin/ruby: symbol lookup error: /usr/local/ruby/ruby-enterprise-1.8.7-2011.03/lib/ruby/gems/1.8/gems/sqlite3-1.3.4/lib/sqlite3/sqlite3_native.so: undefined symbol: sqlite3_open_v2</p>

<h2>解决方案</h2>

<p>退回到1.2.5版本， gem install sqlite3-ruby -v=1.2.5</p>

<h2>服务器相关配置信息</h2>

<p>$ uname -a
Linux fx-40 2.6.18-274.el5 #1 SMP Fri Jul 22 04:43:29 EDT 2011 x86_64 x86_64 x86_64 GNU/Linux
$ rpm -qa | grep sqlite
sqlite-devel-3.3.6-5
sqlite-3.3.6-5
sqlite-3.3.6-5
python-sqlite-1.1.7-1.2.1
sqlite-devel-3.3.6-5</p>

<h2>参考</h2>

<p><a href="http://railsforum.com/viewtopic.php?id=39585">http://railsforum.com/viewtopic.php?id=39585</a></p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/10/09/fix-sqlite3-version-compatibility-problem-on-centos//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/10/09/use-bundle-install-local-to-speed-up-your-gem-install/">
		
			Bundle Install &#8211;local 利用本地缓存来加速Gem安装</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-10-09T16:04:00+08:00" pubdate data-updated="true">Oct 9<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/gemfile/'>Gemfile</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>


</div>
    </div>
		<p>如果Gemfile所列出来的gem全在Gemfile.lock里，加上&mdash;local选项可以直接绕过 请求rubygems.org的gem列表，从而达到加速本地生成Gemfile.lock。</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/10/09/use-bundle-install-local-to-speed-up-your-gem-install//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/09/17/use-binary-search-to-seek-a-position-in-rails-logs/">
		
			二分查找定位Rails文本日志</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-09-17T15:21:54+08:00" pubdate data-updated="true">Sep 17<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rails/'>Rails</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>


</div>
    </div>
		<p>对网站作统计分析时，经常需要对各种文本日志定时进行解析抽取数据，因此有必要确定上次结束解析的位置。<a href="http://github.com/mvj3/logpos">logpos</a>使用<a href="http://en.wikipedia.org/wiki/Binary_search_algorithm">二分法</a>进行查找，具体用法如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">pos</span> <span class="o">=</span> <span class="no">Logpos</span><span class="o">.</span><span class="n">seek_pos_before</span> <span class="n">log_path</span><span class="p">,</span> <span class="p">(</span><span class="no">RptVerbPathParams</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="ss">:time</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:time</span><span class="p">)</span> <span class="o">||</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>logpos是以Rails默认的日志格式来解析的，但是也可以自己定义一个时间解析器：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">lg</span> <span class="o">=</span> <span class="no">Logpos</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">lg</span><span class="o">.</span><span class="n">time_parser</span> <span class="o">=</span> <span class="nb">proc</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>  <span class="n">line</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^Started/</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="no">TIME_PARSER_CLASS</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/for [0-9\.]* at /</span><span class="p">)</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">pos</span> <span class="o">=</span> <span class="n">lg</span><span class="o">.</span><span class="n">seek_pos_before</span> <span class="n">log_path</span><span class="p">,</span> <span class="n">time</span>
</span></code></pre></td></tr></table></div></figure>


<p>Logpos接受的time_parser要求是一个Proc，返回是一个Time实例或nil，以便之后的比较。</p>

<p>我这边测试一个4G多的正常的Rails日志文件，对不同的时间点做测试，日志记录时间范围内的一般在10毫秒以下，范围外的在80毫秒以下。</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/09/17/use-binary-search-to-seek-a-position-in-rails-logs//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/09/13/multiple_rails_apps_sharing_models_folder/">
		
			多个Rails项目共用app/models和Gemfile配置</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-09-13T21:03:03+08:00" pubdate data-updated="true">Sep 13<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rails/'>Rails</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>


</div>
    </div>
		<p>时兴的用Rails做的Web2.0项目一般由桌面浏览器访问的网站，移动客户端的API接口，后台管理，和统计分析等构成。为了项目开发及维护的相对独立性，不可避免地想要拆分成多个子项目，当中不可避免的抽取一些公用代码库，app/models是占很大比例的，完全分开的话重复定义，模型关系校验等就够你悲催了=&ldquo;=。</p>

<p>可以考虑把其中一个项目作为基础库，封装成一个Gem。在lib目录下创建一个share_ws.rb文件，比如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Share</span>
</span><span class='line'>  <span class="no">ModelsPath</span>  <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">))</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;lib&#39;</span><span class="p">,</span> <span class="s1">&#39;app/models&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="no">LibPath</span>     <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">))</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;lib&#39;</span><span class="p">,</span> <span class="s1">&#39;app/lib&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="ss">Share</span><span class="p">:</span><span class="ss">:LibPath</span><span class="p">,</span> <span class="s1">&#39;*rb&#39;</span><span class="p">)</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">lib</span><span class="o">|</span> <span class="nb">require</span> <span class="n">lib</span> <span class="k">rescue</span> <span class="kp">nil</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样你在其他项目的Gemfile里就可以像这样引用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="sb">`whoami`</span><span class="o">.</span><span class="n">strip</span> <span class="o">==</span> <span class="s1">&#39;mvj3&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;ws&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOME&#39;</span><span class="o">]</span> <span class="o">+</span> <span class="s1">&#39;/company/code/ws&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s1">&#39;share_ws&#39;</span> <span class="c1"># 方便本地开发调试</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;ws&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">&#39;git@company.git.server:/data/git/share/ws.git&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s1">&#39;share_ws&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果你对上面为什么要指定版本存在疑问，请移步 <a href="http://mvj3.iteye.com/blogs/1096204">Gemfile里引用没有gemspec的gem</a></p>

<p>然后在config/application.rb的配置里加上一句：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">autoload_paths</span> <span class="o">&lt;&lt;</span> <span class="ss">Share</span><span class="p">:</span><span class="ss">:ModelsPath</span>
</span></code></pre></td></tr></table></div></figure>


<p>既然你看到这里了，想必也厌倦在多个子项目各自的Gemfile写上大同小异的gem包配置，基本情况是总会遇到某个库要依赖某些特定版本库的问题。不过对于大部分完全重复的配置，你大可以在Gemfile直接eval公共配置的Gemfile文件。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">eval</span> <span class="k">begin</span>
</span><span class='line'>  <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../db/Gemfile&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reject</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>    <span class="n">line</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/mysql|thinking-sphinx|arel|delayed_job|sprockets|cache_fu|whenever/i</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/09/13/multiple_rails_apps_sharing_models_folder//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

<nav id="pagenavi">
    
        <a href="/blog/page/3/" class="prev">Prev</a>
    
    
        <a href="/blog/page/5/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>

    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2013

    mvj3
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'mvj3';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
