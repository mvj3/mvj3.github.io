
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>世界的审美！</title>
    <meta name="author" content="mvj3">
    
	<meta name="description" content="Published on: Dec 14th, 2012 Tags: Cache, Nginx, Unicorn nginx方案 接上文 Rails动态文件添加ETag缓存 来自动生成304 Not Modified告诉客户端来直接使用本地缓存，但是在这种情况下会出现图片闪动（重新加载渲染）， &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="世界的审美！" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    
    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-19059295-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        mvj3
    </div>
</h1>
<br>

<ul id="social-links" style="text-align:center">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/mvj3" class="github" title="Github"></a>
  </li>
  
  
  <!-- Google Plus -->
  <li>
  <a href="http://plus.google.com/112424697046854998838?rel=author" class="google" title="Google+"></a>
  </li>
  
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/mvj3" class="twitter" title="Twitter"></a>
  </li>
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/about.html">About</a></li>
	<li id="ajax"><a href="/project.html">Project</a></li>
	<li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        


    <article class="post">
	<h2 class="title">
		
		<a href="/2012/12/14/the-usage-summary-of-deploy-rails-css-js-img-etc-static-cached-assets-via-unicorn-and-nginx/">
		
			Unicorn 和 Nginx 部署Rails应用的 Css, Js, Img 等静态资源缓存使用总结</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2012-12-14T09:41:54+08:00" pubdate data-updated="true">Dec 14<span>th</span>, 2012</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/cache/'>Cache</a>, <a class='category' href='/blog/categories/nginx/'>Nginx</a>, <a class='category' href='/blog/categories/unicorn/'>Unicorn</a>


</div>
    </div>
		<h2>nginx方案</h2>

<p>接上文 <a href="https://gist.github.com/4174674">Rails动态文件添加ETag缓存</a> 来自动生成304 Not Modified告诉客户端来直接使用本地缓存，但是在这种情况下会出现图片闪动（重新加载渲染），影响用户体验。除了Etag这种通过和服务器进行HTTP头部比对来实现缓存的策略外，还可以采用Cache-control来通知浏览器在一段时间内不必重新请求服务器而直接本地缓存。配置 nginx.conf 如下:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="c1"># 使用root用户来避免文件权限问题而导致403错误  </span>
</span><span class='line'><span class="k">user</span>  <span class="s">root</span> <span class="s">nginx</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 在server { } 里加入Cache-Control声明   </span>
</span><span class='line'><span class="k">location</span> <span class="p">~</span> <span class="sr">^/(assets)/</span>  <span class="p">{</span>
</span><span class='line'>  <span class="kn">gzip_static</span> <span class="no">on</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">expires</span>     <span class="s">1h</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">add_header</span>  <span class="s">Cache-Control</span> <span class="s">public</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>配置 config/environments/production.rb 如下:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Disable Rails&#39;s static asset server (Apache or nginx will already do this)  </span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">serve_static_assets</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'><span class="c1"># Compress JavaScripts and CSS  </span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">compress</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'><span class="c1"># Don&#39;t fallback to assets pipeline if a precompiled asset is missed  </span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">compile</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'><span class="c1"># Generate digests for assets URLs  </span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">digest</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'><span class="c1"># 指定需要预先编译的css和js  </span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">precompile</span> <span class="o">+=</span> <span class="sx">%w[js css]</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">ext</span><span class="o">|</span> <span class="no">Dir</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;app/assets/*/*.</span><span class="si">#{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">]</span> <span class="p">}</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>每次重新部署前运行RAILS_ENV=production bundle exec rake assets:precompile 来重新生成静态资源缓存</p>

<h2>Rack方案</h2>

<p><a href="https://github.com/mvj3/rack_image_assets_cache_control/">https://github.com/mvj3/rack_image_assets_cache_control/</a></p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2012/12/14/the-usage-summary-of-deploy-rails-css-js-img-etc-static-cached-assets-via-unicorn-and-nginx//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2012/12/13/compare-the-performance-of-parsing-nginx-log-via-c-sscanf-and-ruby-regexp/">
		
			用C的sscanf和Ruby的正则表达式解析nginx日志性能对比</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2012-12-13T12:18:30+08:00" pubdate data-updated="true">Dec 13<span>th</span>, 2012</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/c/'>C</a>, <a class='category' href='/blog/categories/nginx/'>Nginx</a>, <a class='category' href='/blog/categories/regexp/'>Regexp</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>


</div>
    </div>
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;inline&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ParseLogInC</span>
</span><span class='line'>  <span class="n">inline</span> <span class="k">do</span> <span class="o">|</span><span class="n">builder</span><span class="o">|</span>
</span><span class='line'>    <span class="n">builder</span><span class="o">.</span><span class="n">c</span> <span class="o">&lt;&lt;-</span><span class="no">CODE</span>
</span><span class='line'><span class="sh">      #include &#39;ruby.h&#39;</span>
</span><span class='line'><span class="sh">      #include &#39;stdio.h&#39;f</span>
</span><span class='line'><span class="sh">      static VALUE nginx(VALUE line) {</span>
</span><span class='line'><span class="sh">        VALUE ary = rb_ary_new();</span>
</span><span class='line'><span class="sh"> </span>
</span><span class='line'><span class="sh">        int lt = strlen(STR2CSTR(line));</span>
</span><span class='line'><span class="sh">        char ip_str[24], time_str[26], path[lt &gt; 200 ? lt : 200], i1[4], i2[lt/4];</span>
</span><span class='line'><span class="sh">        sscanf(STR2CSTR(line), &quot;%s - - [%s +0800] %s %s %s&quot;, ip_str, time_str, i1, path, i2);</span>
</span><span class='line'><span class="sh">        rb_ary_push(ary, rb_str_new2(ip_str));</span>
</span><span class='line'><span class="sh">        rb_ary_push(ary, rb_str_new2(time_str));</span>
</span><span class='line'><span class="sh">        rb_ary_push(ary, rb_str_new2(path));</span>
</span><span class='line'><span class="sh"> </span>
</span><span class='line'><span class="sh">        return ary;</span>
</span><span class='line'><span class="sh">      }</span>
</span><span class='line'><span class="no">    CODE</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">NginxLogRegexp</span> <span class="o">=</span> <span class="no">Regexp</span><span class="o">.</span><span class="n">new</span> <span class="o">[</span>
</span><span class='line'>  <span class="s1">&#39;((?:\d+\.){3}\d+)&#39;</span><span class="p">,</span> <span class="c1"># ip</span>
</span><span class='line'>  <span class="s1">&#39;[\ -]*&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;\[(.*?)\]&#39;</span><span class="p">,</span> <span class="c1"># [$time_local]</span>
</span><span class='line'>  <span class="s1">&#39;[\&quot; ]*&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;([A-Z]*) &#39;</span><span class="p">,</span> <span class="c1"># HTTP verb</span>
</span><span class='line'>  <span class="s1">&#39;(.*)&#39;</span><span class="p">,</span> <span class="c1"># url</span>
</span><span class='line'><span class="o">].</span><span class="n">join</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@plc</span> <span class="o">=</span> <span class="no">ParseLogInC</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="o">[</span><span class="sx">%q(123.159.55.238 - - [28/Aug/2012:00:02:11 +0800] &quot;GET //app?id=26964&amp;client_id=142&amp;channel_id=350 HTTP/1.1&quot; 302 0 &quot;-&quot; &quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot; &quot;-&quot; ---- download.eoemarket.com)</span><span class="p">,</span>
</span><span class='line'>    <span class="sx">%q(113.108.11.51 - - [26/Sep/2012:11:12:46 +0800] &quot;GET //app?id=96061&amp;client_id=140&amp;channel_id=319 HTTP/1.1&quot; 302 0 &quot;http://s.myapp.com/dw_stats.jsp?dt=0&amp;sid=AevJEO5AXd56AEqHdh0oAIlG&amp;sn=4&amp;idx=0&amp;siteId=4&amp;apkid=154699&amp;st=0&amp;url=sHdmymPs30ZhvM4YgPxtls6Sl2gYu8dlvbX4xbgOYKjIcB7FqAKXQLATVWAKd0FGCdLEmN%2FB%2FD%2BF%0AtH7nT7X9TWHPqokJ5nFE2YCDnMBkFNM%3D&amp;key=%E6%89%8B%E6%9C%BA%E6%89%93%E7%A2%9F%E6%9C%BA&quot; &quot;MQQBrowser/3.5/Adr (Linux; U; 2.3.6; zh-cn; HUAWEI U8661 Build/U8661V100R001C17B827;320*480)&quot; &quot;211.138.243.113&quot; ---- download.eoemarket.com)</span><span class="p">,</span>
</span><span class='line'>    <span class="sx">%q(117.136.15.146 - - [26/Sep/2012:17:19:58 +0800] &quot;GET /app?id=27034&amp;client_id=12&amp;channel_id=201&amp;uniquely_code=333228032439999999990&amp;w=480&amp;dpi=240&amp;sdk=15&amp;brand=alps&amp;product_id=MX9984K&amp;model=e1809c_v75_gq1008_9p017&amp;product=e1809c_v75_gq1008_9p017&amp;locale=zh_CN&amp;version_code=30&amp;uniquely_code=359220438409074&amp;channel_key=paU3GRB4hk9zOT3gmTTGA&amp;api_key=jPo2Fs9C5a33c9TRNJTPxw&amp;nonce=ef306825998be5dexeb1f6lv0a1b5fca49f8a99a&amp;timestamp=1339080849896&amp;api_sig=d7ew8f2fc5e90dc9e4e0899b7e87o896 HTTP/1.1&quot; 404 3 &quot;-&quot; &quot;Dalvik/1.6.0 (Linux; U; Android 4.0.3; e1809c_v75_gq1008_9p017 Build/IML74K)&quot; &quot;-&quot; ---- download.eoemarket.com)</span>
</span><span class='line'><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>  <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;HTTP/&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">t1</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">;</span> <span class="vi">@plc</span><span class="o">.</span><span class="n">nginx</span><span class="p">(</span><span class="n">l1</span><span class="p">);</span> <span class="nb">puts</span> <span class="s2">&quot;c </span><span class="si">#{</span><span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">to_f</span><span class="o">*</span><span class="mi">100</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">t2</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">;</span> <span class="n">oa</span> <span class="o">=</span> <span class="n">l1</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="no">NginxLogRegexp</span><span class="p">)</span><span class="o">.</span><span class="n">captures</span><span class="p">;</span> <span class="n">ary</span> <span class="o">=</span> <span class="o">[</span><span class="n">oa</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">oa</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="n">oa</span><span class="o">[</span><span class="mi">2</span><span class="o">]]</span><span class="p">;</span> <span class="nb">puts</span> <span class="s2">&quot;r </span><span class="si">#{</span><span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">t2</span><span class="p">)</span><span class="o">.</span><span class="n">to_f</span><span class="o">*</span><span class="mi">100</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="cp">__END__</span>
</span><span class='line'><span class="cp">c 0.14</span>
</span><span class='line'><span class="cp">r 0.37</span>
</span><span class='line'><span class="cp">c 0.04</span>
</span><span class='line'><span class="cp">r 0.1</span>
</span><span class='line'><span class="cp">c 0.05</span>
</span><span class='line'><span class="cp">r 1.42</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2012/12/13/compare-the-performance-of-parsing-nginx-log-via-c-sscanf-and-ruby-regexp//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2012/12/13/require-html5shiv-js-in-haml/">
		
			HAML引用html5shiv.js</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2012-12-13T12:14:55+08:00" pubdate data-updated="true">Dec 13<span>th</span>, 2012</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/haml/'>HAML</a>, <a class='category' href='/blog/categories/html5/'>HTML5</a>, <a class='category' href='/blog/categories/javascript/'>Javascript</a>


</div>
    </div>
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="c">/</span><span class="cs">[if lt IE 9]</span><span class="c"></span>
</span><span class='line'>  <span class="nt">%script</span><span class="p">{</span><span class="ss">:src</span><span class="o">=&gt;</span><span class="s2">&quot;html5shiv/dist/html5shiv.js&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2012/12/13/require-html5shiv-js-in-haml//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2012/11/01/android_eoemarket_data_collect_and_analysis_system_summary/">
		
			Android优亿市场数据采集分析系统概要</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2012-11-01T15:11:00+08:00" pubdate data-updated="true">Nov 1<span>st</span>, 2012</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/analysis/'>Analysis</a>, <a class='category' href='/blog/categories/android/'>Android</a>, <a class='category' href='/blog/categories/dsl/'>DSL</a>, <a class='category' href='/blog/categories/datamining/'>DataMining</a>, <a class='category' href='/blog/categories/mongodb/'>Mongodb</a>


</div>
    </div>
		<h2>目标</h2>

<p>满足公司管理和运营人员，以及外部合作公司的数据需求，业务包括优亿市场应用下载，搜索等。</p>

<h2>难点</h2>

<p>数据量大，实时，多维，只有淘宝等大公司或者专业的大数据公司才能处理。</p>

<h2>实时入库架构</h2>

<p>处理系统 由多个解析引擎和分布式的Mongodb数据库构成。</p>

<ul>
<li>日志数据源 为带时间戳的文本日志，常见的如nginx, sphinx，或定制的应用日志等，分布在各个机器的项目通过NFS把日志目录挂载到处理系统所在节点，或者直接把处理引擎部署到日志所在机器。</li>
<li>解析引擎 用Ruby脚本语言实现，方便根据业务需求灵活快速修改，内存稳定在400-500MB。 它根据上次解析时间点通过 <a href="http://rubygems.org/gems/logpos">二分查找</a> 实现毫秒级定位，并即时批量解析入库，避免了统计报表因数据量大处理时间慢而只能隔天出的弊端，以及重复解析的资源浪费。</li>
</ul>


<p>相关技巧</p>

<ul>
<li>采用批量入库大大节约了带宽开销，入库速度，以及数据库索引优化，入库速度平均达到2万+条日志每分钟。</li>
<li>根据项目对数据精度的不同需求，各自实现了空间时间利用率很高但不百分百精确的bloomfilter或几乎完全精确的SHA加密等不同层级的排重策略。</li>
<li>日志格式通过递增对User-Agent等枚举字段常用标签进行压缩，字段大部分为占用空间极少的整数类型，并通过 <a href="http://rubygems.org/gems/activerecord_idnamecache">activerecord_idnamecache.gem</a> 内存缓存快速访问。</li>
<li><a href="/2012/12/13/compare-the-performance-of-parsing-nginx-log-via-c-sscanf-and-ruby-regexp/">用C的sscanf和Ruby的正则表达式解析nginx日志性能对比</a></li>
</ul>


<h2>统计分析架构</h2>

<p>统计分析构建在具有MapReduce并发分布式处理的Mongodb数据库和流式管道处理的Shell脚本上，并用Ruby脚本语言进行业务定制。</p>

<ul>
<li>需求场景要求该系统具有快速，并发，容错，数据压缩等几个特性，目前日常Job在50+。</li>
<li>为此构建了灵活的面向业务的DSL，比如简单的一行 <code>MapReduce.count EoeDownloadServerNginxLog, [app_id, :channel_id], StatDownloadLogInAppChannel</code> 即可对每天几百万下载日志在十几分钟内统计出每个渠道每个应用的下载量，另外可以在语句块里传入特定的处理逻辑以更满足业务需求。在多维统计数据入库时，只记录了有值的部分，高效利用了磁盘空间。</li>
<li>数据展示 采用Rails web框架开发。用户访问统计时，应用程序先在内存声明空值的多维数组，再填入数据库里有值的部分，最后在浏览器里用图表展示出来，这样有效避免了磁盘IO过慢的问题。</li>
</ul>


<h2>相关演讲</h2>

<p><a href="http://ruby-china.org/topics/5092">2012年09月01日</a> 在盛大创新院做过一次分享, 幻灯片地址在 <a href="http://mvj3.github.io/statistics-analytics-and-dark-knight">统计分析与黑暗骑士</a> 。</p>

<h2>缺陷</h2>

<ol>
<li>如直接按日写日志而不是每日切割的话，那么按上次解析位置重新开始就不需要额外排重。</li>
<li>自定制的简单分割的日志解析会快上几倍。</li>
</ol>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2012/11/01/android_eoemarket_data_collect_and_analysis_system_summary//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/12/31/rebuild-all-mongoid-collections-indexes/">
		
			整个项目的mongoid表重建索引</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-12-31T16:45:09+08:00" pubdate data-updated="true">Dec 31<span>st</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/mongodb/'>Mongodb</a>, <a class='category' href='/blog/categories/mongoid/'>Mongoid</a>


</div>
    </div>
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Object</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:constantize</span><span class="p">)</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="o">.</span><span class="n">included_modules</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span><span class="p">)</span> <span class="k">rescue</span> <span class="kp">nil</span> <span class="p">}</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:create_indexes</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/12/31/rebuild-all-mongoid-collections-indexes//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/12/19/compare-memory-usage-after-init-between-redis-and-memcached/">
		
			Redis和memcached初始化内存比较</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-12-19T16:45:09+08:00" pubdate data-updated="true">Dec 19<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/io/'>IO</a>, <a class='category' href='/blog/categories/memcached/'>memcached</a>, <a class='category' href='/blog/categories/redis/'>redis</a>


</div>
    </div>
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ redis-stat
</span><span class='line'>------- data ------ --------------------- load -------------------- - child -
</span><span class='line'>keys       mem      clients blocked requests            connections
</span><span class='line'>3          1.30M    1       0       150000 (+150000)    751
</span><span class='line'>3          1.30M    1       0       150001 (+1)         751
</span><span class='line'>3          1.30M    1       0       150002 (+1)         751
</span><span class='line'>
</span><span class='line'>$ ps -ef | grep memc
</span><span class='line'>  501 28585     1   0   0:00.00 ??         0:00.00 memcached -d
</span><span class='line'>  501 28596 15675   0   0:00.00 ttys010    0:00.00 grep memc
</span><span class='line'>$ vmmap 28585 | tail -n 2
</span><span class='line'>DefaultMallocZone_0x100065000      18.0M        179      1235K      6%
</span></code></pre></td></tr></table></div></figure>


<p>redis默认比memcachd低多了</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/12/19/compare-memory-usage-after-init-between-redis-and-memcached//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/11/15/Fix-yum-Error-requested-datatype-primary-not-available/">
		
			解决yum错误Error: Requested Datatype Primary Not Available</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-11-15T16:45:09+08:00" pubdate data-updated="true">Nov 15<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/centos/'>CentOS</a>, <a class='category' href='/blog/categories/yum/'>yum</a>


</div>
    </div>
		<h2>服务器信息</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>[mvj3@sdk2 ~]$ cat /proc/version
</span><span class='line'>Linux version 2.6.18-194.el5 (mockbuild@ca-build10.us.oracle.com) (gcc version 4.1.2 20080704 (Red Hat 4.1.2-48)) #1 SMP Mon Mar 29 22:10:29 EDT 2010
</span></code></pre></td></tr></table></div></figure>


<h2>出错信息</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>[mvj3@sdk2 ~]$ sudo yum install gettext-devel httpd-devel openssl-devel zlib-devel gcc gcc-c++ curl-devel expat-devel gettext-devel mysql-server mysql-devel libevent-devel mysql-devel mysql pcre pcre-devel libxml2-devel sqlite-devel ruby-devel -y
</span><span class='line'>Loaded plugins: security
</span><span class='line'>Error: requested datatype primary not available
</span><span class='line'>[mvj3@sdk2 ~]$ sudo yum upgrade
</span><span class='line'>Loaded plugins: security
</span><span class='line'>Error: requested datatype primary not available
</span></code></pre></td></tr></table></div></figure>


<h2>解决方案</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>[mvj3@sdk2 ~]$ sudo yum clean all
</span><span class='line'>Loaded plugins: security
</span><span class='line'>Cleaning up Everything
</span><span class='line'>[mvj3@sdk2 ~]$ sudo rpm --rebuilddb
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/11/15/Fix-yum-Error-requested-datatype-primary-not-available//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/11/03/mongodb-delete-duplicated-data/">
		
			Mongodb删除重复数据</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-11-03T16:49:38+08:00" pubdate data-updated="true">Nov 3<span>rd</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/index/'>Index</a>, <a class='category' href='/blog/categories/mongodb/'>Mongodb</a>, <a class='category' href='/blog/categories/statistical/'>Statistical</a>


</div>
    </div>
		<p>统计分析需要跑各个时间粒度的任务，如果异常中断后重新选择某个时间删除后再跑的时候，有时候还是会有重复的统计数据。</p>

<p>在mongodb中建立唯一索引时加上dropDups选项可以解决此问题：</p>

<p>A unique index cannot be created on a key that has pre-existing duplicate values. If you would like to create the index anyway, keeping the first document the database indexes and deleting all subsequent documents that have duplicate values, add the dropDups option</p>

<p><a href="http://www.mongodb.org/display/DOCS/indexes#Indexes-dropDups">http://www.mongodb.org/display/DOCS/indexes#Indexes-dropDups</a></p>

<p>Mongoid对应的参数配置是 , :unique => true, :background => true, :dropDups => true</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/11/03/mongodb-delete-duplicated-data//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/11/03/exception_notification_rails3-doesnot-send-mail/">
		
			Exception_notification_rails3没有发邮件</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-11-03T16:45:09+08:00" pubdate data-updated="true">Nov 3<span>rd</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/gem/'>Gem</a>, <a class='category' href='/blog/categories/mail/'>Mail</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>


</div>
    </div>
		<p>Rails项目里同事发现配置的 exception_notification_rails3 没有正常的发出异常错误邮件</p>

<p>对比了下我这边正常的配置，把config.middleware.use ExceptionNotifier 放到config/application.rb里最后就可以了，虽然没有从源码里看出问题来 = =</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/11/03/exception_notification_rails3-doesnot-send-mail//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2011/10/20/install-nokogiri-locally-on-centos/">
		
			CentOS本地安装nokogiri</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-10-20T16:45:09+08:00" pubdate data-updated="true">Oct 20<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/centos/'>CentOS</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>, <a class='category' href='/blog/categories/nokogiri/'>nokogiri</a>


</div>
    </div>
		<p>帮同事在一台centos上安装nokogiri，记载如下：</p>

<p>系统信息：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>[root@localhost ~]# uname -a
</span><span class='line'>Linux localhost.localdomain 2.6.18-194.el5 #1 SMP Fri Apr 2 14:58:14 EDT 2010 x86_64 x86_64 x86_64 GNU/Linux
</span><span class='line'>[root@localhost ~]# cat /proc/version
</span><span class='line'>Linux version 2.6.18-194.el5 (mockbuild@builder10.centos.org) (gcc version 4.1.2 20080704 (Red Hat 4.1.2-48)) #1 SMP Fri Apr 2 14:58:14 EDT 2010
</span></code></pre></td></tr></table></div></figure>


<p>卸载并重新安装nokogiri依赖的C库：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo yum remove -y libxml2-devel libxslt-devel
</span><span class='line'>sudo yum install -y libxml2-devel libxslt-devel
</span></code></pre></td></tr></table></div></figure>


<p>最近rubygems.org的在amazon的代码库索引源访问极慢，无奈只能把本地安装过的gems压缩包全部拷上去
scp /usr/local/rvm/gems/ree-1.8.7-2011.03/cache/*gem root@host:~/gems/
然后在服务器上执行 sudo gem i nokogiri-1.5.0.gem  -l 即可</p>

<p>测试代码如下，nokogiri已能正常解析HTML了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="sx">%w[nokogiri open-uri]</span><span class="o">.</span><span class="n">map</span> <span class="o">&amp;</span><span class="nb">method</span><span class="p">(</span><span class="ss">:require</span><span class="p">)</span>
</span><span class='line'><span class="n">resp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;http://www.douban.com&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'><span class="nb">puts</span> <span class="ss">Nokogiri</span><span class="p">:</span><span class="ss">:HTML</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s2">&quot;body .article .content&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2011/10/20/install-nokogiri-locally-on-centos//blog/page/4/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

<nav id="pagenavi">
    
        <a href="/blog/page/3/" class="prev">Prev</a>
    
    
        <a href="/blog/page/5/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>

    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2013

    mvj3
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'mvj3';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
