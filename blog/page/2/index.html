
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>世界的审美！</title>
    <meta name="author" content="mvj3">
    
	<meta name="description" content="Published on: Mar 25th, 2013 Tags: ActiveRecord, Search, Sphinx 问题概述 同事采用的xunsearch搜索引擎在搜索一对多表时遇到了重复内容的问题，问题在通过SQL语句来生成的单表有因为一对多而导致的重复信息。简单google下， &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="世界的审美！" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    
    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-19059295-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        mvj3
    </div>
</h1>
<br>

<ul id="social-links" style="text-align:center">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/mvj3" class="github" title="Github"></a>
  </li>
  
  
  <!-- Google Plus -->
  <li>
  <a href="http://plus.google.com/112424697046854998838?rel=author" class="google" title="Google+"></a>
  </li>
  
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/mvj3" class="twitter" title="Twitter"></a>
  </li>
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/about.html">About</a></li>
	<li id="ajax"><a href="/project.html">Project</a></li>
	<li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        


    <article class="post">
	<h2 class="title">
		
		<a href="/2013/03/25/provide-Xunsearch-no-duplicated-one-to-many-data-list/">
		
			给xunsearch提供一对多的不重复的数据列表</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-03-25T14:07:30+08:00" pubdate data-updated="true">Mar 25<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/activerecord/'>ActiveRecord</a>, <a class='category' href='/blog/categories/search/'>Search</a>, <a class='category' href='/blog/categories/sphinx/'>Sphinx</a>


</div>
    </div>
		<h2>问题概述</h2>

<p>同事采用的xunsearch搜索引擎在搜索一对多表时遇到了重复内容的问题，问题在通过SQL语句来生成的单表有因为一对多而导致的重复信息。简单google下，发现要用group_concat把两个表要用到的文本字段来把每个都合成到一行记录里，但是这样复杂的SQL估计只有大拿才能写的出来。</p>

<h2>解决方案</h2>

<p>于是我想到之前做的thinking-sphinx是支持一对多联合查询的，那就看看thinking-sphinx是如何来生成SQL的。</p>

<p>配置thinking-sphinx，这个参考官网。</p>

<p>code_gists对应多个code_documents，给搜索模块配置索引结构</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CodeGist</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">define_index</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">indexes</span> <span class="n">documents</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:content</span>
</span><span class='line'>    <span class="n">indexes</span> <span class="n">documents</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:content</span>
</span><span class='line'>    <span class="n">indexes</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:content</span>
</span><span class='line'>    <span class="n">indexes</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:content</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">where</span> <span class="s2">&quot;(code_gists.deleted_at IS NULL AND code_documents.deleted_at IS NULL)&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行bundle exec rake ts:config后，在config目录就有了config/production.sphinx.conf文件，察看source区块的sql_query为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">SQL_NO_CACHE</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="o">*</span> <span class="k">CAST</span><span class="p">(</span><span class="mi">3</span> <span class="k">AS</span> <span class="n">SIGNED</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span> <span class="k">AS</span> <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="p">,</span> <span class="n">GROUP_CONCAT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">IFNULL</span><span class="p">(</span><span class="o">`</span><span class="n">code_documents</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">filename</span><span class="o">`</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="n">SEPARATOR</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span> <span class="n">GROUP_CONCAT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">IFNULL</span><span class="p">(</span><span class="o">`</span><span class="n">code_documents</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="n">SEPARATOR</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">description</span><span class="o">`</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="k">AS</span> <span class="o">`</span><span class="n">sphinx_internal_id</span><span class="o">`</span><span class="p">,</span> <span class="mi">0</span> <span class="k">AS</span> <span class="o">`</span><span class="n">sphinx_deleted</span><span class="o">`</span><span class="p">,</span> <span class="mi">1875287073</span> <span class="k">AS</span> <span class="o">`</span><span class="n">class_crc</span><span class="o">`</span><span class="p">,</span> <span class="n">IFNULL</span><span class="p">(</span><span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">author</span><span class="o">`</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">author</span><span class="o">`</span> <span class="k">FROM</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="o">`</span><span class="n">code_documents</span><span class="o">`</span> <span class="k">ON</span> <span class="o">`</span><span class="n">code_documents</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">gist_id</span><span class="o">`</span> <span class="o">=</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="k">WHERE</span> <span class="p">(</span><span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="o">&gt;=</span> <span class="err">$</span><span class="k">start</span> <span class="k">AND</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="o">&lt;=</span> <span class="err">$</span><span class="k">end</span> <span class="k">AND</span> <span class="p">(</span><span class="n">code_gists</span><span class="p">.</span><span class="n">deleted_at</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">AND</span> <span class="n">code_documents</span><span class="p">.</span><span class="n">deleted_at</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">))</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">NULL</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>稍微整理后，变成</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">SQL_NO_CACHE</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">GROUP_CONCAT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">IFNULL</span><span class="p">(</span><span class="o">`</span><span class="n">code_documents</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">filename</span><span class="o">`</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="n">SEPARATOR</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">GROUP_CONCAT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">IFNULL</span><span class="p">(</span><span class="o">`</span><span class="n">code_documents</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="n">SEPARATOR</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span>
</span><span class='line'>                    <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">description</span><span class="o">`</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">IFNULL</span><span class="p">(</span><span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">author</span><span class="o">`</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span>
</span><span class='line'><span class="k">FROM</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span>
</span><span class='line'><span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="o">`</span><span class="n">code_documents</span><span class="o">`</span> <span class="k">ON</span> <span class="o">`</span><span class="n">code_documents</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">gist_id</span><span class="o">`</span> <span class="o">=</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span>
</span><span class='line'><span class="k">WHERE</span> <span class="p">(</span><span class="n">code_gists</span><span class="p">.</span><span class="n">deleted_at</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">AND</span> <span class="n">code_documents</span><span class="p">.</span><span class="n">deleted_at</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">)</span>
</span><span class='line'><span class="k">GROUP</span> <span class="k">BY</span> <span class="o">`</span><span class="n">code_gists</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行一下，就返回了不重复的数据列表了</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2013/03/25/provide-Xunsearch-no-duplicated-one-to-many-data-list//blog/page/2/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2013/03/06/render-haml-independently/">
		
			独立使用HAML渲染</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-03-06T14:45:06+08:00" pubdate data-updated="true">Mar 6<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/haml/'>HAML</a>, <a class='category' href='/blog/categories/renderengine/'>RenderEngine</a>


</div>
    </div>
		<p>对于基本HAML语法可使用下列方法渲染即可</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">content</span>     <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">your_haml_path</span><span class="p">)</span>
</span><span class='line'><span class="n">engine</span>      <span class="o">=</span> <span class="ss">Haml</span><span class="p">:</span><span class="ss">:Engine</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">haml_content</span><span class="p">)</span>
</span><span class='line'><span class="n">engine</span><span class="o">.</span><span class="n">render</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果在content里使用了text_field_tag等view方法，那就需要在给engine指定render的作用域。默认是obj = Object.new，但是这个obj没有text_field_tag方法，所以就需要include ActionPack里对于的View模块，例如</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">HomeController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>   <span class="kp">include</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Helpers</span><span class="o">::</span><span class="no">AssetTagHelper</span>
</span><span class='line'>   <span class="kp">include</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Helpers</span><span class="o">::</span><span class="no">FormTagHelper</span>
</span><span class='line'>   <span class="kp">include</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Helpers</span><span class="o">::</span><span class="no">OutputSafetyHelper</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">engine</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="no">HomeController</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>参考文档</h2>

<ul>
<li><a href="http://haml.info/docs/yardoc/Haml/Engine.html">http://haml.info/docs/yardoc/Haml/Engine.html</a></li>
<li><a href="http://stackoverflow.com/questions/6125265/using-layouts-in-haml-files-independently-of-rails">http://stackoverflow.com/questions/6125265/using-layouts-in-haml-files-independently-of-rails</a></li>
</ul>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2013/03/06/render-haml-independently//blog/page/2/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2013/03/06/rails-general-configuration-problems/">
		
			Rails常见配置问题</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-03-06T10:42:41+08:00" pubdate data-updated="true">Mar 6<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/gemfile/'>Gemfile</a>, <a class='category' href='/blog/categories/rails/'>Rails</a>, <a class='category' href='/blog/categories/assets/'>assets</a>


</div>
    </div>
		<h2>提示已经安装的gem不在Gemfile里</h2>

<p>最近有时遇到明明已经安装了rake，但是却提示我说有些gem没有在Gemfile里引用。比如：
Could not find rake-0.9.2.2 in any of the sources
Run &lsquo;bundle install&rsquo; to install missing gems.</p>

<p>我所使用的Ruby版本管理环境是rvm，查看下rvm info，发现ruby路径和gem管理路径不一致，因此rvm reload一下就解决了该问题。</p>

<p>rvm不一致的问题还需要查下，推测可能是开启多个SHELL，导致设置不一致～</p>

<h2>assets没有编译</h2>

<p>需要显示指定路径，在config/environments/production.rb里加入</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">precompile</span> <span class="o">+=</span> <span class="sx">%w[*js *css]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>development模式下刷新后静态资源不变</h2>

<p>删除public/assets目录下的缓存文件，这样就走动态请求了。</p>

<h2>修复rvm info里ruby版本不一致bug</h2>

<p>在/etc/profile里加一行rvm reload</p>

<h2>修复gem,irb等命令里老是提示ree某个版本的environment不存在</h2>

<p>修改该命令里的ruby环境路径到自己指定的版本</p>

<h2>修复默写外部css引用图片等静态资源不以/assets开头</h2>

<p>把资源及其路径直接拷到/public目录下</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2013/03/06/rails-general-configuration-problems//blog/page/2/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2013/02/26/delete-trailing-blank-in-vim/">
		
			Vim删除行末空格</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-02-26T12:17:53+08:00" pubdate data-updated="true">Feb 26<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/tips/'>Tips</a>, <a class='category' href='/blog/categories/vim/'>Vim</a>


</div>
    </div>
		<p>在查看(View)模式下输入</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="p">:</span>%<span class="k">s</span><span class="sr">/\s\+$/</span><span class="k">g</span>
</span></code></pre></td></tr></table></div></figure>


<p>其实也即是删除了整行都是空格字符的。</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2013/02/26/delete-trailing-blank-in-vim//blog/page/2/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2013/02/25/start-another-process-in-ruby/">
		
			Ruby同时启动另一个进程</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-02-25T14:33:51+08:00" pubdate data-updated="true">Feb 25<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/process/'>Process</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>


</div>
    </div>
		<p>比如自动启动faye服务器, from <a href="http://stackoverflow.com/questions/6430437/autorun-the-faye-server-when-i-start-the-rails-server">http://stackoverflow.com/questions/6430437/autorun-the-faye-server-when-i-start-the-rails-server</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Thread</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;bundle exec rackup faye.ru -s thin -E production&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果是Rails/Rack，加入到项目根目录的config.ru，这样在执行console, rake, migration等其他操作时就不用启动这个进程了。</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2013/02/25/start-another-process-in-ruby//blog/page/2/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2013/02/18/declare-a-Hash-which-default-value-is-blank-array-in-ruby/">
		
			Ruby声明默认是空数组的Hash</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-02-18T12:13:50+08:00" pubdate data-updated="true">Feb 18<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/hash/'>Hash</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>


</div>
    </div>
		<p>Ruby里声明一个新Hash的方法一般是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">im_a_new_hash</span> <span class="o">=</span> <span class="p">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果给它设一个为0的默认值，可以</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">im_a_new_hash</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>变成一行语句就是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">im_a_new_hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是这里注意，这里的0其实是个唯一对象，即是每一个默认值的object_id都是一样的，比如</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">im_a_string_hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="s2">&quot;string&quot;</span> <span class="c1"># =&gt; {}</span>
</span><span class='line'><span class="n">im_a_string_hash</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="c1"># =&gt; &quot;string&quot;</span>
</span><span class='line'><span class="n">im_a_string_hash</span><span class="o">[</span><span class="mi">3</span><span class="o">].</span><span class="n">object_id</span> <span class="c1"># =&gt; 2168523080</span>
</span><span class='line'><span class="n">im_a_string_hash</span><span class="o">[</span><span class="mi">4</span><span class="o">].</span><span class="n">object_id</span> <span class="c1"># =&gt; 2168523080</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到取键3和4的默认值的object_id都是2168523080</p>

<p>Ruby里提供了new {|hash, key| block } → new_hash的方法, 因此声明一个默认是空数组的Hash的具体方法应该是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">im_a_default_array_hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">key</span><span class="o">|</span> <span class="nb">hash</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="o">[]</span> <span class="p">}</span> <span class="c1"># =&gt; {}</span>
</span><span class='line'><span class="n">im_a_default_array_hash</span><span class="o">[</span><span class="mi">99</span><span class="o">]</span> <span class="c1"># =&gt; []</span>
</span><span class='line'><span class="n">im_a_default_array_hash</span><span class="o">[</span><span class="mi">99</span><span class="o">].</span><span class="n">object_id</span> <span class="c1"># =&gt; 160533940</span>
</span><span class='line'><span class="n">im_a_default_array_hash</span><span class="o">[</span><span class="mi">99</span><span class="o">].</span><span class="n">object_id</span> <span class="c1"># =&gt; 160533940</span>
</span><span class='line'><span class="n">im_a_default_array_hash</span><span class="o">[</span><span class="mi">100</span><span class="o">].</span><span class="n">object_id</span> <span class="c1"># =&gt; 160571060 </span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到键99的值的object_id一直是160533940，而键100的值的object_id则是160571060</p>

<p>具体文档查看 <a href="http://www.ruby-doc.org/core-1.9.3/Hash.html#method-c-new">http://www.ruby-doc.org/core-1.9.3/Hash.html#method-c-new</a></p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2013/02/18/declare-a-Hash-which-default-value-is-blank-array-in-ruby//blog/page/2/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2013/02/18/Dir-glob-cache-bug-in-ruby/">
		
			Ruby的Dir.glob缓存BUG</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-02-18T10:56:07+08:00" pubdate data-updated="true">Feb 18<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/cache/'>Cache</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>


</div>
    </div>
		<p>Ruby的Dir.glob(&lsquo;/your/absolute/path/*&rsquo;)有缓存bug，新文件并不会返回，改成FileUtils.chdir后在Dir.glob(pattern)解决</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2013/02/18/Dir-glob-cache-bug-in-ruby//blog/page/2/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2013/01/30/some-thoughts-about-of-tool-culture-after-reading-creating-facebook/">
		
			关于《打造Facebook》第四章第七节 硅谷盛行的“工具文化”的一些思考</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-01-30T20:57:59+08:00" pubdate data-updated="true">Jan 30<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/culture/'>Culture</a>, <a class='category' href='/blog/categories/facebook/'>Facebook</a>, <a class='category' href='/blog/categories/tool/'>Tool</a>


</div>
    </div>
		<p>牛掰的技术公司在程序员里往往都是推崇的，Google, Facebook，等等，但这里面限于团队和文化因素，并不是所有公司都可以像他们那样，人多，人才多，给于的自由支配时间多。</p>

<h2>该章里提到的两类工具</h2>

<ul>
<li>平台型：动态分配开发机器资源，Git代码检查和代码规则，灰度发布，数据检测，用户报告和案例审察。</li>
<li>应用型：TODO list, 用户反馈自动分配，招聘测题，绩效考核（最后因专业难度的问题被替换了），考勤系统。</li>
</ul>


<h2>再来看看Facebook比较有名的开源框架</h2>

<p>Facebook是世界顶级的技术公司之一，做一定规模的云计算等不在话下，比如数据处理框架Hive，BigTable数据库cassandra，php编译框架hiphop，等等。</p>

<h2>工具和开源框架有什么区别？</h2>

<p>从技术难度上，工具难度一般远小于上面提及的开源项目。一家公司贡献开源项目，很大程度上是该公司业务里非核心竞争力技术对技术社区的贡献，比如Taobao。而工具，它像你平时配置的快捷键或常用脚本，个人性的东西比较强。</p>

<h2>看看工具文化推广的现实性</h2>

<p>互联网公司作为商业机构是靠业务盈利的，所以可以看到的情况是，除了做平台的，一般公司很少有精力和能力去开发专门的工具，作者王淮在该节最后也承认了，&#8221;相比面向用户的商品，让工程师去开发内部工具是需要去说服的。如果真正做到如此重视，最优秀的工程师是愿意加入工具团队的。”</p>

<h2>应用型工具文化推广的可能性</h2>

<p>不建议做，除非很多部门的大公司，比如facebook，做好业务最关键。因为已经有一些专业的人去做了，比如evernote，dropbox，等等。如果你是个人兴趣，想做一个开源的完备的，就另当别论了。</p>

<h2>平台型工具文化推广的可能性</h2>

<p>这是真正该做的，而且是鼓励做的。但是做之前先搜搜看是否已经有解决方案，上google，上github，或者code.eoe.cn ;)。如果没有，做完后尽量把它开源出来，让别人不用重新发明轮子，让更多更好的想法参与进来，说不定还能因此交上不错的朋友。目前Github上<a href="https://github.com/languages/Ruby" title="Ruby语言">Ruby</a>里最火的项目是什么呢？是一个叫做Homebrew的专门处理OSX软件库安装的包管理工具，大名鼎鼎的Rails Web框架正跟在它的后面，可见工具对解放人的生产力远大于业务上的。</p>

<p>所以，不用太拘泥于一定要学Facebook，写写<a href="http://blog.eoe.cn/" title="Blog">博客</a>总结自己的小技巧，分享一些不错的<a href="http://code.eoe.cn" title="代码">代码</a>，那样就够了。</p>

<p>本文存放在 <a href="http://code.eoe.cn/198">code.eoe.cn 的gist版本</a> 。</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2013/01/30/some-thoughts-about-of-tool-culture-after-reading-creating-facebook//blog/page/2/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2013/01/30/recent-visitors-implement/">
		
			最近访客实现</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-01-30T18:19:00+08:00" pubdate data-updated="true">Jan 30<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/api/'>API</a>, <a class='category' href='/blog/categories/algorithm/'>Algorithm</a>


</div>
    </div>
		<h2>问题分两个，一个是后端，一个是前端。</h2>

<p>对后端来说，用户每次blog/index|show访问都生成访问记录，后端需要进行排重和去掉未登陆用户。如果在该次访问里进行，特别是某个博客突然火了，必然每次访问都产生IO(磁盘或网络，因为多进程要共享信息），所以必定是异步的。</p>

<p>前端展示考虑到缓存，一般是页面片段缓存，或者ajax载入。</p>

<p>后端异步如何计算每个blog的最近访客，log.js记录了最近访问，一个后台常驻进程循环对日志表按时间记录来读取blog访问信息，把最近访客信息刷新。相对单次请求全部处理，这里处理次数更少，资源更节约，当然瓶颈也在日志表的索引更新和读取。</p>

<h2>把当前自己的访问也添加上</h2>

<p>上面唯一的缺陷是不能马上在当次访问里加上当前自己的访客信息，这个其实可以通过一个技巧来解决，那就是在浏览器里去把ajax获取来的访客列表加上自己的访客信息就OK了。两个注意点是排重和排除访问自己的页面。</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2013/01/30/recent-visitors-implement//blog/page/2/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/2013/01/27/interview-frontend-engineer-can-also-be-so-vivid/">
		
			前端工程师的面试也可以如此生动</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-01-27T22:43:49+08:00" pubdate data-updated="true">Jan 27<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/frontend/'>Frontend</a>, <a class='category' href='/blog/categories/interview/'>Interview</a>


</div>
    </div>
		<p>公司下半年因*.eoe.cn项目要开发上线，寻找合适的前端工程师势在必行。过程很坎坷，我翻了下自己的工作日志，招聘过程达三个月之久。来面试的有互联网公司的，培训学校的，同事推荐的，&hellip;，各种基本功薄弱的，薪资漫天要价的，不靠谱啊。最终相中了一个工作两三年的，在偏时尚媒体设计公司待过的女前端工程师。</p>

<p>面试是和其他同事一起进行的，除了对品性和工作方式的考察外，专业方面看的还是基础知识和经验。前端工程师一般分两类，一种是设计+CSS，关键词也就是Dreamweaver+Photoshop，这种人较多，但通常计算机知识薄弱。另一种是JS+CSS，偏重浏览器内的MVC, 这种人比较少，也是业界稀缺的。可能有人会说两者都包的人，那这种人是全才，基本都可以去创业了。我本身是Ruby(Rails）后端背景的，对前端略懂，而浏览器兼容性几乎没接触过。因此面试偏CSS的不太容易问出什么，也就是面试宝典里的绝对定位法，inline和block区别，jQuery选择器优化，等之类的。</p>

<p>一个偶然的机会，在问到一个前来面试的觉得国内有哪些觉得不错的前端产品的时候，有人提到了网易的新闻聚合（见下图news.tags.163.png），它采用了不同大小矩形色块的TreeMap可视化方式展现了新闻资讯集合。从源码上说，它只有不到150行的规整的HTML结构，足够在短时间内把握。让我们边看这个网页边面试：</p>

<ol>
<li> 点击右上角的刷新按钮后，每个资讯元素重新滑动排列，这里可以考察HTML5的CSS，下面的&#8221;今天, 三天，一周&#8221;的时间范围的切换也是。</li>
<li> 在这里还可以去问这些元素是重新排列，还是从服务器端获取的，可以让对方去源码里找出是哪一行还是引用的文件里调用了ajax。</li>
<li> 打开chrome的调试器，并点击Network标签，在重新加载后，有些请求的Status变成了304，有些Size变成了from cache，这里可以去考察HTTP常识。</li>
<li> 刚才我们翻开了HTML源码，问下css引用链接在上而js引用在下的原因，考察浏览器的渲染顺序。</li>
<li> 接着我们又发现新闻数据并没有在HTML里看到，看对方是否可以知晓js如何调用。</li>
<li> 看过css后，我们发现一个script标签里的type是text/x-micro-template，问下这是干什么的。如果对方回答出模版后，可以再去模版的实现原理，这样就实际就考察了对js闭包的了解。</li>
<li> js代码里面有些英文单词，可以趁机考考英文水平，很多工程师都没听说过github的。</li>
</ol>


<p>问到这里的时候，水平自然见分晓了。这种方式虽然系统考察了一个前端该具备的技术能力，但事后证明它会让某些在CSS方面不错的和能实际快速的干活的人才错过了。
对一般的互联网团队来说，1, CSS命名的规范结构化，2, 严格遵守jQuery链式调用规范，而不是一大堆东抄西补的原生js，3, 和快速的动手能力，前端工程师的这三点才是最重要的。</p>

<p>Android技术招聘可参看@iceskysl 的 <a href="http://my.eoe.cn/iceskysl/archive/21.html">说说我招聘android技术人员的思路</a> ，里面提到的4个点对招聘一般的应用工程师其实都适用。</p>

<p>本文存放在 <a href="http://code.eoe.cn/145">code.eoe.cn 的gist版本</a> 。</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/2013/01/27/interview-frontend-engineer-can-also-be-so-vivid//blog/page/2/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

<nav id="pagenavi">
    
        <a href="/" class="prev">Prev</a>
    
    
        <a href="/blog/page/3/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>

    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2013

    mvj3
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'mvj3';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
